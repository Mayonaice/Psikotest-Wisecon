@{
    ViewData["Title"] = "View Screening";
    Layout = "_DashboardLayout";
}
<div class="px-0 py-0 text-[#111827]">
  <h1 class="text-3xl font-semibold text-[#1E90FF]">View Screening</h1>

  <div id="filterBox" class="mt-4 ml-3 mr-3 inline-block bg-[#EBEBE9] border border-gray-300 rounded-xl px-3 py-3 w-[32rem]">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <span class="text-sm text-gray-700 w-32">Tanggal Input</span>
        <div class="flex items-center gap-2 w-80 justify-between">
          <span class="w-3 h-3 rounded-sm bg-[#1E90FF]"></span>
          <input id="sInputStart" type="date" class="border border-gray-300 rounded-md px-2 py-1 w-40" />
          <span class="text-gray-700">To</span>
          <input id="sInputEnd" type="date" class="border border-gray-300 rounded-md px-2 py-1 w-40" />
        </div>
      </div>
      <div class="flex items-center gap-3 mb-2">
        <span class="text-sm text-gray-700 w-32">Status Seleksi</span>
        <select id="sStatusSeleksi" class="border border-gray-300 rounded-md px-2 py-1 w-80">
          <option value="">Semua Status</option>
          <option value="Belum Proses">Belum Proses</option>
          <option value="Interview Proses">Interview Proses</option>
          <option value="Interview Tidak Datang">Interview Tidak Datang</option>
          <option value="Psikotest Proses">Psikotest Proses</option>
          <option value="Psikotest Tidak Datang">Psikotest Tidak Datang</option>
        </select>
      </div>
      <div class="flex items-center gap-3 mb-2">
        <span class="text-sm text-gray-700 w-32">Status Verifikasi</span>
        <select id="sStatusVerifikasi" class="border border-gray-300 rounded-md px-2 py-1 w-80">
          <option value="">Semua Status</option>
          <option value="Lulus">Lulus</option>
          <option value="Tidak Lulus">Tidak Lulus</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnSRefresh" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7">
          <img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/RefreshNB.svg")" alt="Refresh" class="w-4 h-4" />
          <span>Refresh</span>
        </button>
        <button id="btnSExport" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7">
          <img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/ExportNB.png")" alt="Export" class="w-4 h-4" />
          <span>Export</span>
        </button>
      </div>
    </div>
  </div>

  <div id="titleTop" class="mx-3 bg-[#EBEBE9] border border-gray-300 rounded-t-xl px-3 py-1 font-semibold">Screening</div>
  <div id="gridTop" class="mx-3 border border-gray-300 border-t-0 rounded-b-xl mb-4">
    <div class="table-scroll overflow-x-auto overflow-y-auto max-h-[50vh]">
      <table id="tblScreeningTop" class="min-w-full text-sm">
        <thead>
          <tr class="bg-[#EBEBE9]">
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Num</span><span class="sort-icons" data-sort="num"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Code</span><span class="sort-icons" data-sort="code"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Name</span><span class="sort-icons" data-sort="name"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Belum Proses</span><span class="sort-icons" data-sort="belumProses"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-center" colspan="2"><div class="th-inner th-center"><span>Interview</span></div></th>
            <th class="px-1 py-1 text-center" colspan="2"><div class="th-inner th-center"><span>Psikotest</span></div></th>
            <th class="px-1 py-1 text-center" colspan="2"><div class="th-inner th-center"><span>Status</span></div></th>
          </tr>
          <tr class="bg-[#EBEBE9]">
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1 text-center"><div class="th-inner th-center"><span>Proses</span><span class="sort-icons" data-sort="interviewProses"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-center"><div class="th-inner th-center"><span>Tidak Datang</span><span class="sort-icons" data-sort="interviewTidakDatang"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-center"><div class="th-inner th-center"><span>Proses</span><span class="sort-icons" data-sort="psikotestProses"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-center"><div class="th-inner th-center"><span>Tidak Datang</span><span class="sort-icons" data-sort="psikotestTidakDatang"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-center"><div class="th-inner th-center"><span>Lulus</span><span class="sort-icons" data-sort="statusLulus"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-center"><div class="th-inner th-center"><span>Tidak Lulus</span><span class="sort-icons" data-sort="statusTidakLulus"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          </tr>
          <tr>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1 search-cell"><input data-field="code" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="name" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="belumProses" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="interviewProses" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="interviewTidakDatang" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="psikotestProses" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="psikotestTidakDatang" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="statusLulus" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="statusTidakLulus" class="col-search-top border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-loader"><div class="spinner"></div></div>
    </div>
    <div class="px-1 py-1 text-gray-600 text-xs relative flex items-center justify-center">
      <div class="flex items-center gap-4">
        <span>Show</span>
        <select id="pageSizeTop" class="btn-flat px-2 py-1 rounded-md w-20">
          <option>10</option>
          <option>5</option>
          <option>25</option>
        </select>
        <span>entries</span>
        <div class="flex items-center gap-2" id="pagerTop">
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="prev">Previous</button>
          <span id="pageNumsTop" class="inline-flex items-center gap-1"></span>
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="next">Next</button>
        </div>
        <span id="infoTop" class="ml-2"></span>
      </div>
    </div>
  </div>

  <div id="titleBiodata" class="mx-3 bg-[#EBEBE9] border border-gray-300 rounded-t-xl px-3 py-1 font-semibold">View Screening Biodata</div>
  <div id="gridBiodata" class="mx-3 border border-gray-300 border-t-0 rounded-b-xl">
    <div class="table-scroll overflow-x-auto overflow-y-auto max-h-[50vh]">
      <table id="tblBiodata" class="min-w-full text-sm">
        <thead>
          <tr class="bg-[#EBEBE9]">
            <th class="px-1 py-1 w-16 text-left"><div class="th-inner"><div id="selectAllBiodata" class="select-square" title="Pilih semua"></div></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Num</span><span class="sort-icons" data-sort="num"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 w-12 text-left"><div class="th-inner"><span></span></div></th>
            <th class="px-1 py-1 w-12 text-left"><div class="th-inner"><span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Kode Lowongan</span><span class="sort-icons" data-sort="kodeLowongan"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Posisi Lowongan</span><span class="sort-icons" data-sort="posLowongan"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Batch</span><span class="sort-icons" data-sort="batch"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Name</span><span class="sort-icons" data-sort="name"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Status Screening</span><span class="sort-icons" data-sort="statusScreening"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Status Verifikasi</span><span class="sort-icons" data-sort="statusVerifikasi"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Hasil Tes Interview</span><span class="sort-icons" data-sort="hasilInterview"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Hasil Psikotest</span><span class="sort-icons" data-sort="hasilPsikotest"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Jenis Kelamin</span><span class="sort-icons" data-sort="jenisKelamin"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Email</span><span class="sort-icons" data-sort="email"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>No HP</span><span class="sort-icons" data-sort="noHp"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Pendidikan Terakhir</span><span class="sort-icons" data-sort="pendidikanTerakhir"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
            <th class="px-1 py-1 text-left"><div class="th-inner"><span>Time Input</span><span class="sort-icons" data-sort="timeInput"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          </tr>
          <tr>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1"></th>
            <th class="px-1 py-1 search-cell"><input data-field="kodeLowongan" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="posLowongan" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="batch" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="name" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="statusScreening" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="statusVerifikasi" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="hasilInterview" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="hasilPsikotest" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="jenisKelamin" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="email" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="noHp" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="pendidikanTerakhir" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
            <th class="px-1 py-1 search-cell"><input data-field="timeInput" class="col-search-bio border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-loader"><div class="spinner"></div></div>
    </div>
    <div class="px-1 py-1 text-gray-600 text-xs relative flex items-center justify-center">
      <div class="flex items-center gap-4">
        <span>Show</span>
        <select id="pageSizeBiodata" class="btn-flat px-2 py-1 rounded-md w-20">
          <option>10</option>
          <option>5</option>
          <option>25</option>
        </select>
        <span>entries</span>
        <div class="flex items-center gap-2" id="pagerBiodata">
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="prev">Previous</button>
          <span id="pageNumsBiodata" class="inline-flex items-center gap-1"></span>
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="next">Next</button>
        </div>
        <span id="infoBiodata" class="ml-2"></span>
      </div>
      <div class="flex items-center gap-2 absolute left-2 top-1/2 -translate-y-1/2">
        <button id="btnApprove" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7">
          <img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/ProcessNB.png")" alt="Approve" class="w-4 h-4" />
          <span>Approve</span>
        </button>
      </div>
    </div>
  </div>

  <style>
  .table-loader{ position:absolute; inset:0; display:none; background:rgba(255,255,255,0.65); align-items:center; justify-content:center; z-index:10; }
  .table-scroll.loading .table-loader{ display:flex; }
  .btn-flat{ background:#FFFFFF; border:1px solid #d1d5db; color:#111827; }
  .btn-flat{ transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease, transform .05s ease; }
  .btn-flat:hover{ background:#F9FAFB; border-color:#cbd5e1; box-shadow:0 1px 2px rgba(0,0,0,0.06); }
  .btn-flat:active{ background:#f3f4f6; border-color:#bfc7d8; box-shadow: inset 0 1px 2px rgba(0,0,0,0.12); transform: translateY(1px); }
  .btn-flat:focus-visible{ outline:2px solid #1E90FF; outline-offset:2px; }
  .th-inner{ display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%; }
  .th-center{ justify-content:center; }
  .sort-icons .asc, .sort-icons .desc{ margin:0; padding:0; }
  .sort-icons .asc, .sort-icons .desc{ color:#9CA3AF; cursor:pointer; }
  .sort-icons .asc.active, .sort-icons .desc.active{ color:#111827; }
  .search-cell{ text-align:left; }
  .search-cell input{ display:block; width:100%; }
  .row-active{ background:#E5E7EB !important; }
  #tblScreeningTop thead th, #tblBiodata thead th{ font-weight:400; }
  .date-formatted{ position:relative; padding-right:2.25rem; }
  .date-formatted::before{ content: attr(data-display); position:absolute; left:.5rem; right:2.25rem; top:50%; transform:translateY(-50%); color:#111827; pointer-events:none; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .date-formatted::-webkit-datetime-edit{ color:transparent; }
  .date-formatted::-webkit-calendar-picker-indicator{ opacity:1; position:absolute; right:.5rem; top:50%; transform:translateY(-50%); margin:0; padding:0; cursor:pointer; }
  .row-select{ accent-color:#1E90FF; width:16px; height:16px; }
  .icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; }
  #filterBox{ display:block; box-sizing:border-box; max-width: calc(100% - 24px); margin-left:12px; margin-right:12px; }
  .select-square{ display:inline-block; width:18px; height:18px; border:1px solid #d1d5db; border-radius:4px; background:#fff; cursor:pointer; }
  .select-square.selected{ background:#1E90FF; border-color:#1E90FF; }
  </style>

  <script>
    var sInputStart = document.getElementById('sInputStart');
    var sInputEnd = document.getElementById('sInputEnd');
    var sStatusSeleksi = document.getElementById('sStatusSeleksi');
    var sStatusVerifikasi = document.getElementById('sStatusVerifikasi');
    var btnSRefresh = document.getElementById('btnSRefresh');
    var btnSExport = document.getElementById('btnSExport');

    var pageSizeTop = document.getElementById('pageSizeTop');
    var pagerTop = document.getElementById('pagerTop');
    var pageNumsTop = document.getElementById('pageNumsTop');
    var infoTop = document.getElementById('infoTop');
    var tblBodyTop = document.querySelector('#tblScreeningTop tbody');

    var tblBodyBiodata = document.querySelector('#tblBiodata tbody');
    var pageSizeBiodata = document.getElementById('pageSizeBiodata');
    var pagerBiodata = document.getElementById('pagerBiodata');
    var pageNumsBiodata = document.getElementById('pageNumsBiodata');
    var infoBiodata = document.getElementById('infoBiodata');

    var rawTop = [];
    var rawBiodata = [];
    var selected = { key:null };

    function fmtDateOnly(d){ var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; var dd=('0'+d.getDate()).slice(-2); var mm=months[d.getMonth()]; var yy=d.getFullYear(); return dd+' '+mm+' '+yy; }
    function enhanceDateInput(input){ var iso=input.value; input.classList.add('date-formatted'); var d = iso ? new Date(iso) : null; input.dataset.display = d ? fmtDateOnly(d) : ''; input.addEventListener('change', function(){ var iso2 = input.value; var d2 = iso2 ? new Date(iso2) : null; input.dataset.display = d2 ? fmtDateOnly(d2) : ''; }); }
    function withinRange(d, start, end){ var ds=new Date(start+"T00:00:00"); var de=new Date(end+"T23:59:59"); return d>=ds && d<=de; }
    function initDefaults(){ var now=new Date(); var start=new Date(now.getFullYear(), now.getMonth(), 1); var end=new Date(now.getFullYear(), now.getMonth()+1, 0); var toISO=function(d){ return d.toISOString().slice(0,10); }; sInputStart.value=toISO(start); sInputEnd.value=toISO(end); enhanceDateInput(sInputStart); enhanceDateInput(sInputEnd); }

    var searchTop = {}; var sortTop = { field:null, dir:1 }; var currentPageTop = 1;
    var searchBio = {}; var sortBio = { field:null, dir:1 }; var currentPageBio = 1;

    function fetchTop(){ var sc=document.querySelector('#tblScreeningTop')?document.querySelector('#tblScreeningTop').closest('.table-scroll'):null; if(sc) sc.classList.add('loading'); var s=sInputStart.value; var e=sInputEnd.value; var ss=sStatusSeleksi.value; var sv=sStatusVerifikasi.value; var url='@Url.Content("~/Screening/Top/List")'+'?fromDate='+encodeURIComponent(s)+'&toDate='+encodeURIComponent(e)+'&statusSeleksi='+encodeURIComponent(ss)+'&statusVerifikasi='+encodeURIComponent(sv); return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(rows){ rawTop=(rows||[]).map(function(x,i){ var name=x.name||x.nama||''; return { num:i+1, code:x.code||x.kodeLowongan||'', name:name, key:x.key||name, belumProses:x.belumProses||0, interviewProses:x.interviewProses||x.interviewProsesCount||0, interviewTidakDatang:x.interviewTidakDatang||x.interviewTidakDatangCount||0, psikotestProses:x.psikotestProses||x.psikotestProsesCount||0, psikotestTidakDatang:x.psikotestTidakDatang||x.psikotestTidakDatangCount||0, statusLulus:x.statusLulus||x.lulus||0, statusTidakLulus:x.statusTidakLulus||x.tidakLulus||0, timeInput:x.timeInput||x.time||null }; }); currentPageTop=1; applyTop(); }).catch(function(err){ console.error('screening top error', err); }).finally(function(){ if(sc) sc.classList.remove('loading'); }); }

    function fetchBiodata(kode){ var sc=document.querySelector('#tblBiodata')?document.querySelector('#tblBiodata').closest('.table-scroll'):null; if(sc) sc.classList.add('loading'); var s=sInputStart.value; var e=sInputEnd.value; var ss=sStatusSeleksi.value; var sv=sStatusVerifikasi.value; var url='@Url.Content("~/Screening/Biodata/List")'+'?kodeLowongan='+encodeURIComponent(kode||'')+'&fromDate='+encodeURIComponent(s)+'&toDate='+encodeURIComponent(e)+'&statusSeleksi='+encodeURIComponent(ss)+'&statusVerifikasi='+encodeURIComponent(sv); return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(rows){ rawBiodata=(rows||[]).map(function(x,i){ return { selected:false, kodeLowongan:x.kodeLowongan||kode||'', kodeBiodata:x.kodeBiodata||x.kode||'', posLowongan:x.posLowongan||x.posisi||'', batch:x.batch||'', name:x.name||x.nama||'', statusScreening:x.statusScreening||'', statusVerifikasi:x.statusVerifikasi||'', hasilInterview:x.hasilInterview||'', hasilPsikotest:x.hasilPsikotest||x.hasil||'', jenisKelamin:x.jenisKelamin||x.jk||x.sex||'', email:x.email||'', noHp:x.noHp||x.noHP||x.phoneNo||'', pendidikanTerakhir:x.pendidikanTerakhir||x.pendidikan||'', timeInput:x.timeInput||x.time||'' }; }); currentPageBio=1; applyBiodata(); }).catch(function(err){ console.error('screening biodata error', err); }).finally(function(){ if(sc) sc.classList.remove('loading'); }); }

    function applyTop(){ var s=sInputStart.value; var e=sInputEnd.value; var ss=sStatusSeleksi.value; var sv=sStatusVerifikasi.value; var rows=rawTop.filter(function(x){ var okDate=true; if(x.timeInput){ var dt=new Date(x.timeInput); okDate=withinRange(dt,s,e); } var okSel=!ss || (ss==='Belum Proses' && x.belumProses>0) || (ss==='Interview Proses' && x.interviewProses>0) || (ss==='Interview Tidak Datang' && x.interviewTidakDatang>0) || (ss==='Psikotest Proses' && x.psikotestProses>0) || (ss==='Psikotest Tidak Datang' && x.psikotestTidakDatang>0); var okVer=!sv || (sv==='Lulus' && x.statusLulus>0) || (sv==='Tidak Lulus' && x.statusTidakLulus>0); var okSearch=true; Object.keys(searchTop).forEach(function(k){ var v=(searchTop[k]||'').toLowerCase(); if(v){ var xv=(''+x[k]).toLowerCase(); if(xv.indexOf(v)===-1) okSearch=false; } }); return okDate && okSel && okVer && okSearch; }); if(sortTop.field){ rows.sort(function(a,b){ var av=a[sortTop.field]; var bv=b[sortTop.field]; if(typeof av==='string'){ av=av.toLowerCase(); bv=(''+bv).toLowerCase(); } if(av<bv) return -1*sortTop.dir; if(av>bv) return 1*sortTop.dir; return 0; }); } var pageSize=parseInt(pageSizeTop.value,10)||10; var total=rows.length; var totalPages=Math.max(1, Math.ceil(total/pageSize)); if(currentPageTop>totalPages) currentPageTop=totalPages; var startIdx=(currentPageTop-1)*pageSize; var pageRows=rows.slice(startIdx, startIdx+pageSize); tblBodyTop.innerHTML=''; pageRows.forEach(function(r){ var tr=document.createElement('tr'); tr.setAttribute('data-key', r.key); tr.innerHTML='<td class="px-1 py-1">'+r.num+'</td>'+'<td class="px-1 py-1">'+r.code+'</td>'+'<td class="px-1 py-1">'+r.name+'</td>'+'<td class="px-1 py-1">'+r.belumProses+'</td>'+'<td class="px-1 py-1 text-center">'+r.interviewProses+'</td>'+'<td class="px-1 py-1 text-center">'+r.interviewTidakDatang+'</td>'+'<td class="px-1 py-1 text-center">'+r.psikotestProses+'</td>'+'<td class="px-1 py-1 text-center">'+r.psikotestTidakDatang+'</td>'+'<td class="px-1 py-1 text-center">'+r.statusLulus+'</td>'+'<td class="px-1 py-1 text-center">'+r.statusTidakLulus+'</td>'; tblBodyTop.appendChild(tr); }); infoTop.textContent='Showing '+(total? (startIdx+1) : 0)+' to '+Math.min(startIdx+pageSize,total)+' of '+total+' entries'; pageNumsTop.textContent=''; }

    function fmtDateTime(d){ if(!d) return ''; var dd=new Date(d); var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; var day=('0'+dd.getDate()).slice(-2); var mon=months[dd.getMonth()]; var yy=dd.getFullYear(); var hh=('0'+dd.getHours()).slice(-2); var mi=('0'+dd.getMinutes()).slice(-2); return day+' '+mon+' '+yy+' '+hh+':'+mi; }
    function applyBiodata(){ var rows=rawBiodata.filter(function(x){ var okSearch=true; Object.keys(searchBio).forEach(function(k){ var v=(searchBio[k]||'').toLowerCase(); if(v){ var xv=(''+x[k]).toLowerCase(); if(k==='timeInput'){ xv=fmtDateTime(x.timeInput).toLowerCase(); } if(xv.indexOf(v)===-1) okSearch=false; } }); return okSearch; }); if(sortBio.field){ rows.sort(function(a,b){ var av=a[sortBio.field]; var bv=b[sortBio.field]; if(sortBio.field==='timeInput'){ av=new Date(a.timeInput||0).getTime(); bv=new Date(b.timeInput||0).getTime(); } if(typeof av==='string'){ av=av.toLowerCase(); bv=(''+bv).toLowerCase(); } if(av<bv) return -1*sortBio.dir; if(av>bv) return 1*sortBio.dir; return 0; }); } var pageSize=parseInt(pageSizeBiodata.value,10)||10; var total=rows.length; var totalPages=Math.max(1, Math.ceil(total/pageSize)); if(currentPageBio>totalPages) currentPageBio=totalPages; var startIdx=(currentPageBio-1)*pageSize; var pageRows=rows.slice(startIdx, startIdx+pageSize); tblBodyBiodata.innerHTML=''; pageRows.forEach(function(r,idx){ var tr=document.createElement('tr'); tr.setAttribute('data-key', r.kodeBiodata); tr.setAttribute('data-low', r.kodeLowongan); tr.setAttribute('data-bio', r.kodeBiodata); var num = startIdx + idx + 1; tr.innerHTML='<td class="px-1 py-1"><div class="select-square'+(r.selected?' selected':'')+'"></div></td>'+'<td class="px-1 py-1">'+num+'</td>'+'<td class="px-1 py-1"><button class="icon-btn download-btn"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/DownloadNB.png")" class="w-4 h-4" /></button></td>'+'<td class="px-1 py-1"><button class="icon-btn paper-btn"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/Paper.png")" class="w-4 h-4" /></button></td>'+'<td class="px-1 py-1">'+r.kodeLowongan+'</td>'+'<td class="px-1 py-1">'+r.posLowongan+'</td>'+'<td class="px-1 py-1">'+r.batch+'</td>'+'<td class="px-1 py-1">'+r.name+'</td>'+'<td class="px-1 py-1">'+r.statusScreening+'</td>'+'<td class="px-1 py-1">'+r.statusVerifikasi+'</td>'+'<td class="px-1 py-1">'+r.hasilInterview+'</td>'+'<td class="px-1 py-1">'+r.hasilPsikotest+'</td>'+'<td class="px-1 py-1">'+r.jenisKelamin+'</td>'+'<td class="px-1 py-1">'+r.email+'</td>'+'<td class="px-1 py-1">'+r.noHp+'</td>'+'<td class="px-1 py-1">'+r.pendidikanTerakhir+'</td>'+'<td class="px-1 py-1">'+fmtDateTime(r.timeInput)+'</td>'; tblBodyBiodata.appendChild(tr); }); infoBiodata.textContent='Showing '+(total? (startIdx+1) : 0)+' to '+Math.min(startIdx+pageSize,total)+' of '+total+' entries'; pageNumsBiodata.textContent=''; }

    document.querySelectorAll('.col-search-top').forEach(function(inp){ inp.addEventListener('input', function(){ var f=inp.getAttribute('data-field'); searchTop[f]=inp.value||''; currentPageTop=1; applyTop(); }); });
    document.querySelectorAll('#tblScreeningTop thead .sort-icons').forEach(function(si){ si.addEventListener('click', function(e){ var tgt=e.target; var field=si.getAttribute('data-sort'); if(tgt.classList.contains('asc')){ sortTop.field=field; sortTop.dir=1; } else if(tgt.classList.contains('desc')){ sortTop.field=field; sortTop.dir=-1; } document.querySelectorAll('#tblScreeningTop thead .sort-icons .asc').forEach(function(x){ x.classList.remove('active'); }); document.querySelectorAll('#tblScreeningTop thead .sort-icons .desc').forEach(function(x){ x.classList.remove('active'); }); if(sortTop.dir===1) si.querySelector('.asc').classList.add('active'); else si.querySelector('.desc').classList.add('active'); applyTop(); }); });

    document.querySelectorAll('.col-search-bio').forEach(function(inp){ inp.addEventListener('input', function(){ var f=inp.getAttribute('data-field'); searchBio[f]=inp.value||''; currentPageBio=1; applyBiodata(); }); });
    document.querySelectorAll('#tblBiodata thead .sort-icons').forEach(function(si){ si.addEventListener('click', function(e){ var tgt=e.target; var field=si.getAttribute('data-sort'); if(tgt.classList.contains('asc')){ sortBio.field=field; sortBio.dir=1; } else if(tgt.classList.contains('desc')){ sortBio.field=field; sortBio.dir=-1; } document.querySelectorAll('#tblBiodata thead .sort-icons .asc').forEach(function(x){ x.classList.remove('active'); }); document.querySelectorAll('#tblBiodata thead .sort-icons .desc').forEach(function(x){ x.classList.remove('active'); }); if(sortBio.dir===1) si.querySelector('.asc').classList.add('active'); else si.querySelector('.desc').classList.add('active'); applyBiodata(); }); });

    pagerTop.addEventListener('click', function(e){ var b=e.target.closest('.page-btn'); if(!b) return; var p=b.getAttribute('data-page'); var pageSize=parseInt(pageSizeTop.value,10)||10; var total=Math.max(1, Math.ceil((rawTop||[]).length/pageSize)); if(p==='prev'){ currentPageTop=Math.max(1, currentPageTop-1); } else if(p==='next'){ currentPageTop=Math.min(total, currentPageTop+1); } applyTop(); });
    pageSizeTop.addEventListener('change', function(){ currentPageTop=1; applyTop(); });

    

    document.querySelector('#tblScreeningTop tbody').addEventListener('click', function(e){ var tr=e.target.closest('tr'); if(!tr) return; if(e.target.classList.contains('select-square')){ e.target.classList.toggle('selected'); return; } document.querySelectorAll('#tblScreeningTop tbody tr').forEach(function(x){ x.classList.remove('row-active'); }); tr.classList.add('row-active'); var key=tr.getAttribute('data-key'); selected.key=key; fetchBiodata(selected.key); });
    document.addEventListener('click', function(e){ var selAll=e.target.closest('#selectAllTop'); if(!selAll) return; var sqs=document.querySelectorAll('#tblScreeningTop tbody .select-square'); var allSelected=Array.prototype.every.call(sqs, function(el){ return el.classList.contains('selected'); }); Array.prototype.forEach.call(sqs, function(el){ if(allSelected) el.classList.remove('selected'); else el.classList.add('selected'); }); });

    document.querySelector('#tblBiodata tbody').addEventListener('click', function(e){ var tr=e.target.closest('tr'); if(!tr) return; if(e.target.classList.contains('select-square')){ var key=tr.getAttribute('data-key'); var idx=-1; for(var i=0;i<rawBiodata.length;i++){ if((''+rawBiodata[i].kodeBiodata)===(''+key)){ idx=i; break; } } if(idx>-1){ rawBiodata[idx].selected=!rawBiodata[idx].selected; e.target.classList.toggle('selected', rawBiodata[idx].selected); } return; } if(e.target.closest('.download-btn')){ var kLow=tr.getAttribute('data-low'); var kBio=tr.getAttribute('data-bio'); var url='@Url.Content("~/Screening/Biodata/DownloadNB")'+'?kodeLowongan='+encodeURIComponent(kLow)+'&kodeBiodata='+encodeURIComponent(kBio); window.location.href=url; return; } if(e.target.closest('.paper-btn')){ var kLow=tr.getAttribute('data-low'); var kBio=tr.getAttribute('data-bio'); var url='@Url.Content("~/Screening/Biodata/Paper")'+'?kodeLowongan='+encodeURIComponent(kLow)+'&kodeBiodata='+encodeURIComponent(kBio); window.open(url, '_blank'); return; } });
    document.addEventListener('click', function(e){ var selAll=e.target.closest('#selectAllBiodata'); if(!selAll) return; var sqs=document.querySelectorAll('#tblBiodata tbody .select-square'); var allSelected=Array.prototype.every.call(sqs, function(el){ return el.classList.contains('selected'); }); Array.prototype.forEach.call(sqs, function(el){ el.classList.toggle('selected', !allSelected); var tr=el.closest('tr'); if(tr){ var key=tr.getAttribute('data-key'); var idx=-1; for(var i=0;i<rawBiodata.length;i++){ if((''+rawBiodata[i].kodeBiodata)===(''+key)){ idx=i; break; } } if(idx>-1){ rawBiodata[idx].selected=!allSelected; } } }); });
    pagerBiodata.addEventListener('click', function(e){ var b=e.target.closest('.page-btn'); if(!b) return; var p=b.getAttribute('data-page'); var pageSize=parseInt(pageSizeBiodata.value,10)||10; var total=Math.max(1, Math.ceil((rawBiodata||[]).length/pageSize)); if(p==='prev'){ currentPageBio=Math.max(1, currentPageBio-1); } else if(p==='next'){ currentPageBio=Math.min(total, currentPageBio+1); } applyBiodata(); });
    pageSizeBiodata.addEventListener('change', function(){ currentPageBio=1; applyBiodata(); });

    btnSRefresh.addEventListener('click', function(){ fetchTop().then(function(){ if(rawTop && rawTop.length>0){ selected.key=rawTop[0].key; var r=document.querySelector('#tblScreeningTop tbody tr[data-key="'+selected.key+'"]'); if(r) r.classList.add('row-active'); fetchBiodata(selected.key); } else { rawBiodata=[]; applyBiodata(); } }); });
    btnSExport.addEventListener('click', function(){ var s=sInputStart.value; var e=sInputEnd.value; var ss=sStatusSeleksi.value; var sv=sStatusVerifikasi.value; var url='@Url.Content("~/Screening/Top/Export")'+'?fromDate='+encodeURIComponent(s)+'&toDate='+encodeURIComponent(e)+'&statusSeleksi='+encodeURIComponent(ss)+'&statusVerifikasi='+encodeURIComponent(sv); window.open(url, '_blank'); });

    document.getElementById('btnApprove').addEventListener('click', function(){ var payload=rawBiodata.filter(function(x){ return x.selected; }).map(function(x){ return { kodeBiodata: x.kodeBiodata }; }); if(payload.length===0) return; var url='@Url.Content("~/Screening/Biodata/Approve")'; fetch(url,{ method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'same-origin', body: JSON.stringify({ items: payload }) }).then(function(r){ return r.json().then(function(j){ return { ok:r.ok, json:j }; }); }).then(function(res){ if(!res.ok){ alert((res.json&&res.json.error)||'Gagal approve'); return; } if(res.json && res.json.message){ alert(res.json.message); } else { alert('Approve berhasil'); } fetchBiodata(selected.key); }).catch(function(err){ console.error('approve biodata error', err); }); });

    initDefaults();
    fetchTop().then(function(){ if(rawTop && rawTop.length>0){ selected.key=rawTop[0].key; var r=document.querySelector('#tblScreeningTop tbody tr[data-key="'+selected.key+'"]'); if(r) r.classList.add('row-active'); fetchBiodata(selected.key); } });
  </script>
</div>
