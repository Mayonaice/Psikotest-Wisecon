@{
    ViewData["Title"] = "Master Pertanyaan";
    Layout = "_DashboardLayout";
}
<div class="px-0 py-0 text-[#111827]">
  <h1 class="text-3xl font-semibold text-[#1E90FF]">Master Pertanyaan</h1>

  <div class="mt-4 bg-[#EBEBE9] border border-gray-300 rounded-xl pl-3 pr-3 py-3 w-full max-w-[32rem]">
    <div class="flex items-center gap-3 mb-2">
      <span class="text-sm text-gray-700 w-28">Tanggal Dibuat:</span>
      <div class="flex items-center gap-2 w-80 justify-between">
        <span class="w-3 h-3 rounded-sm bg-[#1E90FF]"></span>
        <input id="qDateStart" type="date" class="border border-gray-300 rounded-md px-2 py-1 w-40" />
        <span class="text-gray-700">To</span>
        <input id="qDateEnd" type="date" class="border border-gray-300 rounded-md px-2 py-1 w-40" />
      </div>
    </div>
    <div class="flex items-center gap-3 mb-2">
      <span class="text-sm text-gray-700 w-28">Status</span>
      <select id="qStatusPaket" class="border border-gray-300 rounded-md px-2 py-1 w-80">
        <option value="">Semua Status</option>
        <option value="AKTIF">Aktif</option>
        <option value="NONAKTIF">Nonaktif</option>
      </select>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnQRefresh" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7">
        <img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/RefreshNB.svg")" alt="Refresh" class="w-4 h-4" />
        <span>Refresh</span>
      </button>
      <button id="btnQExport" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7">
        <img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/ExportNB.png")" alt="Export" class="w-4 h-4" />
        <span>Export</span>
      </button>
    </div>
  </div>

  <div class="mt-4"></div>

  <div id="titlePaket" class=" bg-[#EBEBE9] border border-gray-300 rounded-t-xl px-3 py-1 font-semibold">Paket Soal</div>
  <div id="gridPaket" class="border border-gray-300 border-t-0 rounded-b-xl">
    <div class="table-scroll overflow-x-auto overflow-y-auto max-h-[60vh]">
      <table id="tblPaket" class="min-w-full text-sm">
        <thead>
        <tr class="bg-[#EBEBE9]">
          <th class="px-3 py-1 w-16 text-left"><div id="selectAllPaket" class="select-square" title="Pilih semua"></div></th>
          <th class="px-1 py-1 w-16 text-left"></th>
          <th class="px-1 py-1 w-16 text-left"><div class="th-inner"><span>Num</span><span class="sort-icons" data-sort="num"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>No Paket</span><span class="sort-icons" data-sort="noPaket"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Nama Paket Soal</span><span class="sort-icons" data-sort="namaPaket"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Posisi</span><span class="sort-icons" data-sort="posisi"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Toleransi Waktu (Menit)</span><span class="sort-icons" data-sort="toleransi"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Status</span><span class="sort-icons" data-sort="status"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Input</span><span class="sort-icons" data-sort="userInput"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-3 py-1 text-left"><div class="th-inner"><span>Time Input</span><span class="sort-icons" data-sort="time"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Edit</span><span class="sort-icons" data-sort="userEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Time Edit</span><span class="sort-icons" data-sort="timeEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
        </tr>
        <tr class="bg-[#EBEBE9]">
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1 search-cell"><input data-field="noPaket" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="namaPaket" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="posisi" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="toleransi" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="status" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userInput" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="time" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userEdit" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="timeEdit" class="col-search-paket border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-loader"><div class="spinner"></div></div>
    </div>
    <div class="px-1 py-1 text-gray-600 text-xs relative flex items-center justify-center">
      <div class="flex items-center gap-2 absolute left-2">
        <button id="btnAddPaket" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/AddNB.svg")" alt="Add" class="w-4 h-4" /><span>Add</span></button>
      </div>
      <div class="flex items-center gap-4">
        <span>Show</span>
        <select id="pageSizePaket" class="btn-flat px-2 py-1 rounded-md w-20">
          <option>10</option>
          <option>5</option>
          <option>25</option>
        </select>
        <span>entries</span>
        <div class="flex items-center gap-2" id="pagerPaket">
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="prev">Previous</button>
          <span id="pageNumsPaket" class="inline-flex items-center gap-1"></span>
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="next">Next</button>
        </div>
        <span id="infoPaket" class="ml-2"></span>
      </div>
    </div>
  </div>

  <div id="titleGroup" class=" bg-[#EBEBE9] border border-gray-300 rounded-t-xl px-3 py-1 mt-6 font-semibold">Group Soal</div>
  <div id="gridGroup" class="border border-gray-300 border-t-0 rounded-b-xl">
    <div class="table-scroll overflow-x-auto overflow-y-auto max-h-[60vh]">
      <table id="tblGroup" class="min-w-full text-sm">
        <thead>
        <tr class="bg-[#EBEBE9]">
          <th class="px-3 py-1 w-16 text-left"><div id="selectAllGroup" class="select-square" title="Pilih semua"></div></th>
          <th class="px-1 py-1 w-16 text-left"></th>
          <th class="px-1 py-1 w-16 text-left"><div class="th-inner"><span>Num</span><span class="sort-icons" data-sort="num"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>No Group Soal</span><span class="sort-icons" data-sort="noGroup"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Nama Group</span><span class="sort-icons" data-sort="namaGroup"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Minimum Jumlah Soal</span><span class="sort-icons" data-sort="minSoal"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Nilai Standar</span><span class="sort-icons" data-sort="nilaiStandar"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Waktu Pengerjaan</span><span class="sort-icons" data-sort="waktu"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Acak Nomor Soal</span><span class="sort-icons" data-sort="random"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Status</span><span class="sort-icons" data-sort="status"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Nomor Petunjuk</span><span class="sort-icons" data-sort="petunjuk"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Input</span><span class="sort-icons" data-sort="userInput"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-3 py-1 text-left"><div class="th-inner"><span>Time Input</span><span class="sort-icons" data-sort="time"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Edit</span><span class="sort-icons" data-sort="userEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Time Edit</span><span class="sort-icons" data-sort="timeEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
        </tr>
        <tr class="bg-[#EBEBE9]">
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1 search-cell"><input data-field="noGroup" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="namaGroup" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="minSoal" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="nilaiStandar" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="waktu" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="random" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="status" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="petunjuk" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userInput" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="time" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userEdit" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="timeEdit" class="col-search-group border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-loader"><div class="spinner"></div></div>
    </div>
    <div class="px-1 py-1 text-gray-600 text-xs relative flex items-center justify-center">
      <div class="flex items-center gap-2 absolute left-2">
        <button id="btnAddGroup" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/AddNB.svg")" alt="Add" class="w-4 h-4" /><span>Add</span></button>
        <button id="btnDeleteGroup" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/XNB.png")" alt="Delete" class="w-4 h-4" /><span>Delete</span></button>
      </div>
      <div class="flex items-center gap-4">
        <span>Show</span>
        <select id="pageSizeGroup" class="btn-flat px-2 py-1 rounded-md w-20">
          <option>10</option>
          <option>5</option>
          <option>25</option>
        </select>
        <span>entries</span>
        <div class="flex items-center gap-2" id="pagerGroup">
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="prev">Previous</button>
          <span id="pageNumsGroup" class="inline-flex items-center gap-1"></span>
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="next">Next</button>
        </div>
        <span id="infoGroup" class="ml-2"></span>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-4 mt-6">
    <div>
      <div id="titleDtl" class=" bg-[#EBEBE9] border border-gray-300 rounded-t-xl px-3 py-1 font-semibold">Pertanyaan</div>
      <div id="gridDtl" class="border border-gray-300 border-t-0 rounded-b-xl">
    <div class="table-scroll overflow-x-auto overflow-y-auto max-h-[60vh]">
      <table id="tblDtl" class="min-w-full text-sm">
        <thead>
        <tr class="bg-[#EBEBE9]">
          <th class="px-3 py-1 w-16 text-left"><div id="selectAllDtl" class="select-square" title="Pilih semua"></div></th>
          <th class="px-1 py-1 w-16 text-left"></th>
          <th class="px-1 py-1 w-16 text-left"><div class="th-inner"><span>Num</span><span class="sort-icons" data-sort="num"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>No Urut</span><span class="sort-icons" data-sort="noUrut"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Judul</span><span class="sort-icons" data-sort="judul"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Deskripsi</span><span class="sort-icons" data-sort="deskripsi"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>IsDownload</span><span class="sort-icons" data-sort="isDownload"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Aktif</span><span class="sort-icons" data-sort="aktif"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Url Media</span><span class="sort-icons" data-sort="urlMedia"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Tipe Media</span><span class="sort-icons" data-sort="tipeMedia"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Input</span><span class="sort-icons" data-sort="userInput"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-3 py-1 text-left"><div class="th-inner"><span>Time Input</span><span class="sort-icons" data-sort="time"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Edit</span><span class="sort-icons" data-sort="userEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Time Edit</span><span class="sort-icons" data-sort="timeEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>No Soal</span><span class="sort-icons" data-sort="noSoal"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
        </tr>
        <tr class="bg-[#EBEBE9]">
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1 search-cell"><input data-field="noUrut" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="judul" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="deskripsi" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="isDownload" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="aktif" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="urlMedia" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="tipeMedia" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userInput" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="time" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userEdit" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="timeEdit" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="noSoal" class="col-search-dtl border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-loader"><div class="spinner"></div></div>
    </div>
    <div class="px-1 text-gray-600 text-xs flex flex-col">
      <div class="py-1 flex items-center justify-center">
        <span>Show</span>
        <select id="pageSizeDtl" class="btn-flat px-2 py-1 rounded-md w-20">
          <option>10</option>
          <option>5</option>
          <option>25</option>
        </select>
        <span>entries</span>
        <div class="flex items-center gap-2" id="pagerDtl">
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="prev">Previous</button>
          <span id="pageNumsDtl" class="inline-flex items-center gap-1"></span>
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="next">Next</button>
        </div>
        <span id="infoDtl" class="ml-2"></span>
      </div>
      <div class="py-1 flex items-center justify-start gap-2">
        <button id="btnAddDtl" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/AddNB.svg")" alt="Add" class="w-4 h-4" /><span>Add</span></button>
        <button id="btnImportDtl" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/UploadNB.png")" alt="Import" class="w-4 h-4" /><span>Import</span></button>
        <button id="btnDeleteDtl" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/XNB.png")" alt="Delete" class="w-4 h-4" /><span>Delete</span></button>
        <button id="btnCopyDtl" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/ViewNB.png")" alt="Copy" class="w-4 h-4" /><span>Copy Pertanyaan</span></button>
      </div>
    </div>
  </div>

    </div>
    <div>
      <div id="titleJawaban" class=" bg-[#EBEBE9] border border-gray-300 rounded-t-xl px-3 py-1 font-semibold">Jawaban</div>
      <div id="gridJawaban" class="border border-gray-300 border-t-0 rounded-b-xl">
    <div class="table-scroll overflow-x-auto overflow-y-auto max-h-[60vh]">
      <table id="tblJawaban" class="min-w-full text-sm">
        <thead>
        <tr class="bg-[#EBEBE9]">
          <th class="px-3 py-1 w-16 text-left"><div id="selectAllJawaban" class="select-square" title="Pilih semua"></div></th>
          <th class="px-1 py-1 w-16 text-left"></th>
          <th class="px-1 py-1 w-16 text-left"><div class="th-inner"><span>Num</span><span class="sort-icons" data-sort="num"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>No Jawaban</span><span class="sort-icons" data-sort="noJawaban"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Jawaban</span><span class="sort-icons" data-sort="jawaban"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Poin</span><span class="sort-icons" data-sort="poin"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Tipe Media</span><span class="sort-icons" data-sort="tipeMedia"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Url Media</span><span class="sort-icons" data-sort="urlMedia"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Input</span><span class="sort-icons" data-sort="userInput"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-3 py-1 text-left"><div class="th-inner"><span>Time Input</span><span class="sort-icons" data-sort="time"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>User Edit</span><span class="sort-icons" data-sort="userEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>Time Edit</span><span class="sort-icons" data-sort="timeEdit"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
          <th class="px-1 py-1 text-left"><div class="th-inner"><span>SeqNo</span><span class="sort-icons" data-sort="seqNo"><span class="asc">↑</span><span class="desc">↓</span></span></div></th>
        </tr>
        <tr class="bg-[#EBEBE9]">
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1"></th>
          <th class="px-1 py-1 search-cell"><input data-field="noJawaban" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="jawaban" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="poin" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="tipeMedia" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="urlMedia" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userInput" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="time" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="userEdit" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="timeEdit" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
          <th class="px-1 py-1 search-cell"><input data-field="seqNo" class="col-search-jawaban border border-gray-300 rounded-md px-2 py-1 w-full" /></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-loader"><div class="spinner"></div></div>
    </div>
    <div class="px-1 text-gray-600 text-xs flex flex-col">
      <div class="py-1 flex items-center justify-center">
        <span>Show</span>
        <select id="pageSizeJawaban" class="btn-flat px-2 py-1 rounded-md w-20">
          <option>10</option>
          <option>5</option>
          <option>25</option>
        </select>
        <span>entries</span>
        <div class="flex items-center gap-2" id="pagerJawaban">
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="prev">Previous</button>
          <span id="pageNumsJawaban" class="inline-flex items-center gap-1"></span>
          <button class="page-btn btn-flat px-2 py-1 rounded-md" data-page="next">Next</button>
        </div>
        <span id="infoJawaban" class="ml-2"></span>
      </div>
      <div class="py-1 flex items-center justify-start gap-2">
        <button id="btnAddJawaban" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/AddNB.svg")" alt="Add" class="w-4 h-4" /><span>Add</span></button>
        <button id="btnImportJawaban" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/UploadNB.png")" alt="Import" class="w-4 h-4" /><span>Import</span></button>
        <button id="btnDeleteJawaban" class="btn-flat inline-flex items-center gap-2 px-2 py-1 rounded-md h-7"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/XNB.png")" alt="Delete" class="w-4 h-4" /><span>Delete</span></button>
      </div>
    </div>
      </div>
    </div>
  </div>

  <div id="modalOverlay" class="dct-overlay dct-hidden">
    <div id="modalContent" class="dct-modal">
      <div class="dct-header">
        <img id="modalIcon" src="@Url.Content("~/DCT3_Standarisasi/assets/icons/Confirmation.png")" alt="Modal" />
        <div id="modalHeader" class="dct-title"></div>
      </div>
      <div id="modalBody" class="dct-body"></div>
      <div class="dct-actions">
        <button id="modalSave" class="dct-btn dct-btn-primary" type="button"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/sendNB.png")" class="w-4 h-4" /> <span>Save</span></button>
        <button id="modalTemplate" class="dct-btn" type="button" style="display:none;"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/templateNB.png")" class="w-4 h-4" /> <span>Template</span></button>
        <button id="modalCancel" class="dct-btn" type="button"><img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/XNB.png")" class="w-4 h-4" /> <span>Close</span></button>
      </div>
    </div>
  </div>

  <style>
  .table-scroll{ position:relative; }
  .table-loader{ position:absolute; inset:0; display:none; background:rgba(255,255,255,0.65); align-items:center; justify-content:center; z-index:10; }
  .table-scroll.loading .table-loader{ display:flex; }
  .spinner{ width:28px; height:28px; border:3px solid #d1d5db; border-top-color:#1E90FF; border-radius:50%; animation:spin .9s linear infinite; }
@@keyframes spin{ to{ transform:rotate(360deg); } }
  .row-select{ accent-color:#1E90FF; width:16px; height:16px; }
  .cell{ border-top:1px solid #e5e7eb; }
  .cell:first-child{ border-left:0; }
  .cell:last-child{ border-right:1px solid #c3c5c9ff; }
  #tblPaket thead th:last-child, #tblGroup thead th:last-child, #tblDtl thead th:last-child, #tblJawaban thead th:last-child{ border-right:1px solid #c3c5c9ff; }
  #tblPaket tbody tr:last-child td.cell, #tblGroup tbody tr:last-child td.cell, #tblDtl tbody tr:last-child td.cell, #tblJawaban tbody tr:last-child td.cell{ border-bottom:1px solid #c3c5c9ff; }
  #tblPaket thead th, #tblGroup thead th, #tblDtl thead th, #tblJawaban thead th{ border-bottom:1px solid #e5e7eb; font-weight:600; color:#374151; position:relative; }
  #tblPaket th, #tblPaket td, #tblGroup th, #tblGroup td, #tblDtl th, #tblDtl td, #tblJawaban th, #tblJawaban td{ white-space:nowrap; }
  .btn-flat{ background:#FFFFFF; border:1px solid #d1d5db; color:#111827; }
  .btn-flat{ transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease, transform .05s ease; }
  .btn-flat:hover{ background:#F9FAFB; border-color:#cbd5e1; box-shadow:0 1px 2px rgba(0,0,0,0.06); }
  .btn-flat:active{ background:#f3f4f6; border-color:#bfc7d8; box-shadow: inset 0 1px 2px rgba(0,0,0,0.12); transform: translateY(1px); }
  .btn-flat:focus-visible{ outline:2px solid #1E90FF; outline-offset:2px; }
  .tab-btn{ background:#fff; border:1px solid #d1d5db; color:#111827; margin-right:8px; }
  .th-inner .sort-icons{ position:absolute; right:8px; top:50%; transform:translateY(-50%); display:inline-flex; gap:4px; color:#6b7280; }
  .th-inner .sort-icons .active{ color:#111827; }
  .select-square{ display:inline-block; width:18px; height:18px; border:1px solid #d1d5db; border-radius:4px; background:#fff; cursor:pointer; }
  .select-square.selected{ background:#1E90FF; border-color:#1E90FF; }
  .row-active{ background:#E5E7EB !important; }
  .hidden{ display:none; }
  .row-edit-btn{ display:inline-flex; align-items:center; justify-content:center; gap:6px; padding-left:0.5rem !important; padding-right:0.5rem !important; vertical-align:middle; box-sizing:border-box; }
  .row-edit-btn{ padding-top:0.25rem !important; padding-bottom:0.25rem !important; min-height:28px; border-radius:6px; }
  .row-edit-btn:focus, .row-edit-btn:hover, .row-edit-btn:active{ padding-left:8px !important; padding-right:8px !important; }
  .row-edit-btn img{ width:16px !important; height:16px !important; display:block !important; }
  .row-edit-btn.btn-flat{ border-color:#f7b900 !important; }
  .row-edit-btn.btn-flat:hover{ border-color:#f7b900 !important; }
  .row-edit-btn.icon-only{ width:32px; min-width:32px; height:28px; padding:0 !important; }
  .row-edit-btn.icon-only:focus, .row-edit-btn.icon-only:hover, .row-edit-btn.icon-only:active{ padding:0 !important; }
  .date-formatted{ position:relative; padding-right:2.25rem; }
  .date-formatted::before{ content: attr(data-display); position:absolute; left:.5rem; right:2.25rem; top:50%; transform:translateY(-50%); color:#111827; pointer-events:none; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .date-formatted::-webkit-datetime-edit{ color:transparent; }
  .date-formatted::-webkit-calendar-picker-indicator{ opacity:1; position:absolute; right:.5rem; top:50%; transform:translateY(-50%); margin:0; padding:0; cursor:pointer; }
  #modalContent .dct-actions{ justify-content:flex-end; }
  .modal-form{ display:grid; grid-template-columns:160px 1fr; gap:8px 12px; }
  .modal-form .modal-label{ font-size:14px; align-self:center; }
  .modal-form .modal-field{ display:flex; align-items:center; gap:8px; }
  .modal-form input, .modal-form select{ border:1px solid #d1d5db; border-radius:6px; padding:4px 8px; }
  .modal-form .w-24{ width:6rem; }
  .modal-form textarea{ border:1px solid #d1d5db; border-radius:6px; padding:6px 8px; min-height:220px; }
  .modal-form input[type='file']{ display:none !important; }
  .posisi-dropdown{ position:relative; width:100%; }
  .posisi-toggle{ width:100%; text-align:left; background:#fff; border:1px solid #d1d5db; border-radius:6px; padding:4px 8px; }
  .posisi-menu{ position:absolute; top:100%; left:0; right:0; max-height:220px; overflow:auto; background:#fff; border:1px solid #d1d5db; border-radius:6px; margin-top:4px; padding:6px; z-index:40; box-shadow:0 8px 16px rgba(0,0,0,0.08); }
  .posisi-item{ display:flex; align-items:center; gap:8px; padding:4px 6px; border-radius:4px; }
  .posisi-item:hover{ background:#F9FAFB; }
  .upload-placeholder{ border:1px solid #e5e7eb; border-radius:10px; padding:16px 12px; min-height:76px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; color:#6b7280; background:linear-gradient(180deg,#ffffff 0%,#f8fafc 100%); cursor:pointer; width:100%; box-shadow:0 1px 2px rgba(16,24,40,0.04); transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease, color .15s ease; }
  .upload-placeholder:hover{ border-color:#cbd5e1; color:#4b5563; box-shadow:0 2px 6px rgba(16,24,40,0.08); }
  .upload-placeholder:active{ transform:translateY(1px); }
  .upload-title{ font-weight:600; color:#111827; }
  .upload-hint{ font-size:12px; color:#6b7280; }
  .upload-preview{ border:1px solid #e5e7eb; border-radius:10px; padding:10px; min-height:120px; background:#fff; width:100%; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 2px rgba(16,24,40,0.04); }
  #modalContent.dct-modal{ width:auto; min-width:480px; max-width:95vw; display:inline-block; }
  .modal-field input:not([type='radio']):not([type='checkbox']), .modal-field select, .modal-field textarea, .rt-area, #dToolbar{ width:100%; }
  .rt-toolbar{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
  .rt-toolbar button{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border:1px solid #d1d5db; border-radius:4px; background:#fff; }
  .rt-area{ border:1px solid #d1d5db; border-radius:6px; padding:6px 8px; min-height:220px; }
  .modal-field.media-types{ flex-wrap:nowrap; gap:16px; }
  .modal-field.media-types .inline-flex{ white-space:nowrap; }
  #modalOverlay .dct-btn{ display:inline-flex; align-items:center; gap:8px; white-space:nowrap; }
  #modalOverlay .dct-btn img{ width:18px; height:18px; display:inline-block; }
  #modalOverlay #modalContent{ background:#FFFFFF; }
  #modalOverlay .dct-btn{ border:1px solid #d1d5db; background:#FFFFFF; }
  #modalOverlay .dct-btn:hover{ background:#F9FAFB; }
  #modalOverlay .dct-header{ border-bottom:1px solid #e5e7eb; padding-bottom:10px; }
  #modalOverlay .dct-actions{ border-top:1px solid #e5e7eb; padding-top:10px; }
  </style>

  <script src="https://cdn.ckeditor.com/4.25.1/standard/ckeditor.js"></script>
  <script>
    (function(){
      var iconBase = '@Url.Content("~/DCT3_Standarisasi/assets/icons/")';
      var ICON_DEBUG = false;
      var iconDebugLog = [];
      function logIconDebug(entry){
        if(!ICON_DEBUG) return;
        try{
          var row = Object.assign({ t: new Date().toISOString() }, entry || {});
          iconDebugLog.push(row);
          if(iconDebugLog.length > 80) iconDebugLog.shift();
          if(row.event === 'error'){
            console.error('[Questions Icon]', row);
          } else {
            console.log('[Questions Icon]', row);
          }
        } catch(e){}
      }
      window.__questionsIconDebugDump = function(){ return iconDebugLog.slice(); };
      window.__questionsIconDebugEnable = function(on){ ICON_DEBUG = !!on; };
      window.__questionsIconDebugProbe = async function(){
        var url = iconBase + 'editnb.png';
        var res = null;
        try{
          res = await fetch(url, { method:'GET', cache:'no-store', credentials:'same-origin' });
        } catch(e){
          logIconDebug({ event:'probe_error', src:url, message: (e && e.message) ? e.message : (''+e) });
          return;
        }
        var ct = res && res.headers ? res.headers.get('content-type') : null;
        logIconDebug({ event:'probe', src:url, ok: !!(res && res.ok), status: res ? res.status : null, contentType: ct });
      };
      function attachIconDebug(img, context){
        if(!ICON_DEBUG || !img) return;
        img.addEventListener('load', function(){
          logIconDebug({ event:'load', context:context, src:img.src, naturalWidth:img.naturalWidth, naturalHeight:img.naturalHeight });
        });
        img.addEventListener('error', function(){
          logIconDebug({ event:'error', context:context, src:img.src });
          img.style.display = 'none';
          var s = document.createElement('span');
          s.textContent = '!';
          s.style.display = 'inline-flex';
          s.style.alignItems = 'center';
          s.style.justifyContent = 'center';
          s.style.width = '16px';
          s.style.height = '16px';
          s.style.fontSize = '12px';
          s.style.fontWeight = '700';
          s.style.color = '#B91C1C';
          img.parentElement && img.parentElement.appendChild(s);
        });
      }
      function makeEditButton(type, key, context){
        var btn = document.createElement('button');
        btn.className = 'row-edit-btn icon-only btn-flat rounded-md';
        btn.setAttribute('data-type', type);
        btn.setAttribute('data-key', key);
        btn.title = 'Edit';
        btn.style.backgroundImage = 'url(' + (iconBase + 'editnb.png') + ')';
        btn.style.backgroundRepeat = 'no-repeat';
        btn.style.backgroundPosition = 'center';
        btn.style.backgroundSize = '16px 16px';
        if(ICON_DEBUG){
          var img = new Image();
          img.src = iconBase + 'editnb.png';
          attachIconDebug(img, context);
        }
        return btn;
      }
      var toISODate = function(d){ return d.toISOString().slice(0,10); };
      function fmtDateOnly(d){ var m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; var dd=('0'+d.getDate()).slice(-2); var mm=m[d.getMonth()]; var yy=d.getFullYear(); return dd+' '+mm+' '+yy; }
      function fmtDateTime(d){ var m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; var dd=('0'+d.getDate()).slice(-2); var mm=m[d.getMonth()]; var yy=d.getFullYear(); var hh=('0'+d.getHours()).slice(-2); var mi=('0'+d.getMinutes()).slice(-2); return dd+' '+mm+' '+yy+' '+hh+':'+mi; }
      function within(d,s,e){ var ds=new Date(s+"T00:00:00"); var de=new Date(e+"T23:59:59"); return d>=ds && d<=de; }
      function enhanceDateInput(input){ var iso=input.value; input.classList.add('date-formatted'); var d = iso ? new Date(iso) : null; input.dataset.display = d ? fmtDateOnly(d) : ''; input.addEventListener('change', function(){ var iso2 = input.value; var d2 = iso2 ? new Date(iso2) : null; input.dataset.display = d2 ? fmtDateOnly(d2) : ''; }); }

      var modalOverlay = document.getElementById('modalOverlay');
      var modalHeader = document.getElementById('modalHeader');
      var modalBody = document.getElementById('modalBody');
      var modalCancel = document.getElementById('modalCancel');
      var modalSave = document.getElementById('modalSave');
      var modalTemplate = document.getElementById('modalTemplate');
      var modalIcon = document.getElementById('modalIcon');
      var modalClose = document.getElementById('modalClose');
      function openModal(title, bodyHtml, onSave, opts){
        opts = opts || {};
        modalHeader.textContent = title;
        modalBody.innerHTML = bodyHtml;
        if (modalIcon) {
          var t = (title || '').toLowerCase();
          var icon = '@Url.Content("~/DCT3_Standarisasi/assets/icons/Confirmation.png")';
          if (t.indexOf('hapus') > -1) icon = '@Url.Content("~/DCT3_Standarisasi/assets/icons/Alert.png")';
          if (t.indexOf('import') > -1) icon = '@Url.Content("~/DCT3_Standarisasi/assets/icons/Information.png")';
          if (t.indexOf('tambah') > -1 || t.indexOf('add') > -1) icon = '@Url.Content("~/DCT3_Standarisasi/assets/icons/AddNB.svg")';
          if (t.indexOf('edit') > -1) icon = iconBase + 'editnb.png';
          modalIcon.src = icon;
        }
        modalOverlay.classList.remove('dct-hidden');
        modalOverlay.style.display = 'flex';
        if (document.getElementById('dJudul')) { setupDtlFormInteractions(); }
        if (document.getElementById('jNoPaket')) { setupJawabanFormInteractions(); }
        if (document.getElementById('fPosition')) { setupPaketFormInteractions(); }
        if (document.getElementById('impDtl')) { setupImportFormInteractions('impDtl','detail'); }
        if (document.getElementById('impJawaban')) { setupImportFormInteractions('impJawaban','answer'); }
        var close = function(){ modalOverlay.style.display = 'none'; modalOverlay.classList.add('dct-hidden'); };
        if (modalClose) modalClose.onclick = close;
        if (modalCancel){ modalCancel.innerHTML = '<img src="@Url.Content("~/DCT3_Standarisasi/assets/icons/XNB.png")" class="w-4 h-4" /> <span>Close</span>'; modalCancel.onclick = close; }
        if (modalTemplate){
          if (opts.onTemplate){
            var tIcon = opts.templateIcon || '@Url.Content("~/DCT3_Standarisasi/assets/icons/templateNB.png")';
            var tText = opts.templateText || 'Template';
            modalTemplate.style.display = 'inline-flex';
            modalTemplate.innerHTML = '<img src="'+tIcon+'" class="w-4 h-4" /> <span>'+tText+'</span>';
            modalTemplate.onclick = function(){ opts.onTemplate(); };
          } else {
            modalTemplate.style.display = 'none';
            modalTemplate.onclick = null;
          }
        }
        if (modalSave){
          var sIcon = opts.saveIcon || '@Url.Content("~/DCT3_Standarisasi/assets/icons/sendNB.png")';
          var sText = opts.saveText || 'Save';
          modalSave.innerHTML = '<img src="'+sIcon+'" class="w-4 h-4" /> <span>'+sText+'</span>';
          modalSave.onclick = function(){ if(onSave){ var r=onSave(); if(r && typeof r.then==='function'){ r.then(close).catch(close); } else { close(); } } else { close(); } };
        }
      }
      function getImportDefaults(kind){
        var np = selected && selected.paket ? String(selected.paket) : '';
        var ng = selected && selected.group ? String(selected.group) : '';
        var ns = '';
        if(kind==='answer' && selected && selected.dtlSeqNo){
          var idx = findByKey(rawDtl,'seqNo',selected.dtlSeqNo);
          if(idx===-1) idx = findByKey(rawDtl,'noSoal',selected.dtlSeqNo);
          if(idx>-1 && rawDtl[idx] && rawDtl[idx].noUrut!=null) ns = String(rawDtl[idx].noUrut);
        }
        return { noPaket: np, noGroup: ng, noSoal: ns };
      }
      function importFormBody(inputId, kind){
        var label = (kind === 'answer') ? 'jawaban' : 'pertanyaan';
        return '<div class="modal-form">'+
          '<div class="modal-label">File:</div><div class="modal-field"><input id="'+inputId+'" type="file" accept=".xlsx" /><label for="'+inputId+'" class="upload-placeholder"><span class="upload-title">Pilih file</span><span class="upload-hint">XLSX</span></label></div>'+
          '<div class="modal-label">Preview:</div><div class="modal-field"><div id="'+inputId+'Preview" class="upload-preview">Preview: 0 '+label+'</div></div>'+
        '</div>';
      }
      function setupImportFormInteractions(inputId, kind){
        var input = document.getElementById(inputId);
        var preview = document.getElementById(inputId+'Preview');
        if(!input || !preview) return;
        var label = (kind === 'answer') ? 'jawaban' : 'pertanyaan';
        var resetPreview = function(){ preview.textContent = 'Preview: 0 ' + label; };
        input.addEventListener('change', function(){
          resetPreview();
          var f = input.files && input.files[0] ? input.files[0] : null;
          if(!f) return;
          if(!/\.xlsx$/i.test(f.name||'')){
            toast('Format file harus XLSX');
            input.value = '';
            resetPreview();
            return;
          }
          var fd = new FormData();
          fd.append('file', f);
          var d = getImportDefaults(kind);
          if(d.noPaket) fd.append('noPaket', d.noPaket);
          if(d.noGroup) fd.append('noGroup', d.noGroup);
          if(d.noSoal) fd.append('noSoal', d.noSoal);
          var url = (kind === 'answer') ? '@Url.Content("~/Questions/Import/Answer/Preview")' : '@Url.Content("~/Questions/Import/Detail/Preview")';
          fetch(url, { method:'POST', body:fd })
            .then(function(r){ return r.json().then(function(data){ return { ok:r.ok, data:data }; }); })
            .then(function(res){
              if(!res.ok){ toast((res.data && res.data.error) || 'Gagal preview'); resetPreview(); return; }
              var c = (res.data && typeof res.data.count === 'number') ? res.data.count : 0;
              preview.textContent = 'Preview: ' + c + ' ' + label;
            });
        });
      }
      function buildTemplateUrl(kind){
        var base = kind==='answer' ? '@Url.Content("~/Questions/Template/Answer")' : '@Url.Content("~/Questions/Template/Detail")';
        var np = selected && selected.paket ? String(selected.paket) : '';
        var ng = selected && selected.group ? String(selected.group) : '';
        var ns = '';
        if(kind==='answer' && selected && selected.dtlSeqNo){
          var idx = findByKey(rawDtl,'seqNo',selected.dtlSeqNo);
          if(idx===-1) idx = findByKey(rawDtl,'noSoal',selected.dtlSeqNo);
          if(idx>-1 && rawDtl[idx] && rawDtl[idx].noUrut!=null) ns = String(rawDtl[idx].noUrut);
        }
        var params = [];
        if(np) params.push('noPaket='+encodeURIComponent(np));
        if(ng) params.push('noGroup='+encodeURIComponent(ng));
        if(ns) params.push('noSoal='+encodeURIComponent(ns));
        return params.length ? (base + '?' + params.join('&')) : base;
      }
      function findByKey(arr, key, value){ for(var i=0;i<arr.length;i++){ if((''+arr[i][key])===(''+value)) return i; } return -1; }
      var masterPosisiOptions = null;
      function fetchMasterPosisiOptions(){
        if(masterPosisiOptions) return Promise.resolve(masterPosisiOptions);
        return fetch('@Url.Content("~/Questions/Paket/Posisi/Options")', { method:'GET', credentials:'same-origin' })
          .then(function(r){ if(!r.ok) return []; return r.json(); })
          .then(function(j){
            var raw = Array.isArray(j) ? j : [];
            var arr = raw.map(function(x){ return (x==null?'':(''+x)).trim(); }).filter(function(x){ return !!x; });
            var seen = {};
            masterPosisiOptions = arr.filter(function(x){ if(seen[x]) return false; seen[x]=true; return true; });
            return masterPosisiOptions;
          });
      }
      function splitPosList(v){ return (v||'').split(/[;,]/).map(function(x){ return (x||'').trim(); }).filter(function(x){ return x; }); }
      function normalizePosList(v){ var arr = splitPosList(v); var seen = {}; return arr.filter(function(x){ if(seen[x]) return false; seen[x]=true; return true; }); }
      function setupPaketFormInteractions(){
        var hidden = document.getElementById('fPosition');
        var toggle = document.getElementById('fPositionToggle');
        var menu = document.getElementById('fPositionMenu');
        var wrap = document.getElementById('fPositionWrap');
        if(!hidden || !toggle || !menu || !wrap) return;
        var currentRaw = (hidden.value || hidden.getAttribute('data-current') || '').trim();
        var selected = splitPosList(currentRaw);
        hidden.value = selected.join(',');
        toggle.textContent = selected.length ? selected.join(', ') : 'Pilih posisi';
        menu.innerHTML = '<div class="text-sm text-gray-500 px-2 py-1">Loading...</div>';
        fetchMasterPosisiOptions().then(function(list){
          var values = (list||[]).slice();
          selected.forEach(function(v){ if(values.indexOf(v) === -1) values.unshift(v); });
          menu.innerHTML = '';
          values.forEach(function(v){
            if(!v) return;
            var item = document.createElement('label');
            item.className = 'posisi-item';
            var cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = v;
            cb.checked = selected.indexOf(v) > -1;
            var sp = document.createElement('span');
            sp.textContent = v;
            item.appendChild(cb);
            item.appendChild(sp);
            cb.addEventListener('change', function(){
              var picks = Array.prototype.slice.call(menu.querySelectorAll('input[type="checkbox"]:checked')).map(function(x){ return x.value; });
              hidden.value = picks.join(',');
              toggle.textContent = picks.length ? picks.join(', ') : 'Pilih posisi';
            });
            menu.appendChild(item);
          });
          if(values.length === 0){
            menu.innerHTML = '<div class="text-sm text-gray-500 px-2 py-1">Data posisi kosong</div>';
          }
        });
        toggle.addEventListener('click', function(e){
          e.stopPropagation();
          menu.classList.toggle('hidden');
        });
        menu.addEventListener('click', function(e){ e.stopPropagation(); });
        if(window.__posisiCloseHandler){ document.removeEventListener('click', window.__posisiCloseHandler); }
        window.__posisiCloseHandler = function(ev){ if(!wrap.contains(ev.target)) menu.classList.add('hidden'); };
        document.addEventListener('click', window.__posisiCloseHandler);
      }
      function paketForm(o){ var np=o.noPaket||''; var na=o.namaPaket||''; var to=o.toleransi||0; var st=o.status||'AKTIF'; var po=(o.posisi||''); return (
        '<div class="modal-form">'+
          '<div class="modal-label">Nomor Paket Soal:</div><div class="modal-field"><input id="fNoPaket" value="'+np+'" readonly /></div>'+
          '<div class="modal-label">Nama Paket Soal:</div><div class="modal-field"><input id="fNamaPaket" value="'+na+'" /></div>'+
          '<div class="modal-label">Toleransi Waktu:</div><div class="modal-field"><input id="fToleransi" type="number" class="w-24" value="'+to+'" /><span>Menit</span></div>'+
          '<div class="modal-label">Posisi:</div><div class="modal-field"><div id="fPositionWrap" class="posisi-dropdown"><button type="button" id="fPositionToggle" class="posisi-toggle">Pilih posisi</button><div id="fPositionMenu" class="posisi-menu hidden"></div><input type="hidden" id="fPosition" data-current="'+po+'" value="'+po+'"/></div></div>'+
          '<div class="modal-label">Status:</div><div class="modal-field">'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="fStatus" value="AKTIF"'+(st==='AKTIF'?' checked':'')+' /> <span>Aktif</span></label>'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="fStatus" value="NONAKTIF"'+(st!=='AKTIF'?' checked':'')+' /> <span>Nonaktif</span></label>'+
          '</div>'+
        '</div>'
      ); }
      function initPosisiTokens(codes){ var wrap=document.getElementById('posisiTokens'); var input=document.getElementById('posisiAdd'); if(!wrap||!input) return; function addChip(code){ code=(code||'').trim(); if(!code) return; var exists = Array.prototype.some.call(wrap.querySelectorAll('.chip'), function(el){ return (el.getAttribute('data-code')||'')===code; }); if(exists) return; var chip=document.createElement('span'); chip.className='chip inline-flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded'; chip.setAttribute('data-code', code); chip.innerHTML='<span>'+code+'</span><button class="btn-flat px-1">×</button>'; var btn=chip.querySelector('button'); btn.addEventListener('click', function(){ chip.remove(); }); wrap.insertBefore(chip, input); }
        (codes||[]).forEach(addChip);
        input.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===','){ e.preventDefault(); var val=input.value; addChip(val); input.value=''; } }); }

      var petunjukOptions = [];
      var petunjukPromise = null;
      function getPetunjukLabel(value){
        if(value===null || value===undefined) return '';
        var id=parseInt(value,10);
        if(isNaN(id)) return ''+value;
        var opt=(petunjukOptions||[]).find(function(x){ return x.seqNo===id; });
        return opt ? opt.keterangan : ''+value;
      }
      function applyPetunjukLabels(){
        (rawGroup||[]).forEach(function(r){
          var id = (r.petunjukId!==undefined && r.petunjukId!==null) ? r.petunjukId : r.petunjuk;
          r.petunjukId = id;
          r.petunjuk = getPetunjukLabel(id);
        });
        applyGroup();
      }
      function fetchPetunjuk(){
        var url='@Url.Content("~/Questions/Petunjuk/List")';
        return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(j){
          petunjukOptions=(j||[]).map(function(x){
            var seq = x.seqNo;
            if(seq===null || seq===undefined) seq = x.no || x.id || 0;
            var id = parseInt(seq,10);
            return { seqNo:isNaN(id)?0:id, keterangan:(x.keterangan||x.text||'') };
          }).filter(function(x){ return x.keterangan!=='' || x.seqNo!==0; });
          applyPetunjukLabels();
          return petunjukOptions;
        }).catch(function(){ return []; });
      }
      function ensurePetunjuk(){ if(petunjukPromise) return petunjukPromise; petunjukPromise = fetchPetunjuk(); return petunjukPromise; }
      function renderPetunjukSelect(current){
        var cur=parseInt(current,10);
        var hasCur=!isNaN(cur) && cur>0;
        var hasList=(petunjukOptions||[]);
        var html='<select id="gNoPetunjuk">';
        html+='<option value="">-- pilih petunjuk --</option>';
        hasList.forEach(function(p){
          if(!p || (!p.seqNo && !p.keterangan)) return;
          var sel=(hasCur && p.seqNo===cur)?' selected':'';
          html+='<option value="'+p.seqNo+'"'+sel+'>'+p.keterangan+'</option>';
        });
        if(hasCur && !hasList.some(function(p){ return p && p.seqNo===cur; })) html+='<option value="'+cur+'" selected>'+cur+'</option>';
        html+='</select>';
        return html;
      }

      function groupForm(o){ var np=(o.noPaket||selected.paket||''); var ng=o.noGroup||''; var nm=o.namaGroup||''; var ms=(o.minSoal||0); var ns=(o.nilaiStandar||0); var w=(o.waktu||0); var pj=(o.petunjukId!==undefined && o.petunjukId!==null)?o.petunjukId:(o.petunjuk||0); var bRand=(o.random==='Ya'); var bAktif=(o.status==='AKTIF'); return (
        '<div class="modal-form">'+
          '<div class="modal-label">Nomor Paket Soal:</div><div class="modal-field"><input id="gNoPaket" value="'+np+'" readonly /></div>'+
          '<div class="modal-label">Nomor Group Soal:</div><div class="modal-field"><input id="gNoGroup" value="'+ng+'" readonly /></div>'+
          '<div class="modal-label">Nama Group Soal:</div><div class="modal-field"><input id="gNamaGroup" value="'+nm+'" /></div>'+
        '</div>'+
        '<div class="modal-form mt-3">'+
          '<div class="modal-label">Minimum Jumlah Soal:</div><div class="modal-field"><input id="gMinSoal" type="number" class="w-24" value="'+ms+'" /> <span>Soal</span></div>'+
          '<div class="modal-label">Nilai Standar:</div><div class="modal-field"><input id="gNilaiStandar" type="number" class="w-24" value="'+ns+'" /> <span>Poin</span></div>'+
          '<div class="modal-label">Waktu Pengerjaan:</div><div class="modal-field"><input id="gWaktu" type="number" class="w-24" value="'+w+'" /> <span>Menit</span></div>'+
          '<div class="modal-label">Nomor Petunjuk:</div><div class="modal-field">'+renderPetunjukSelect(pj)+'</div>'+
          '<div class="modal-label">Acak Nomor:</div><div class="modal-field">'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="gRandom" value="Ya"'+(bRand?' checked':'')+' /> <span>Aktif</span></label>'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="gRandom" value="Tidak"'+(!bRand?' checked':'')+' /> <span>Nonaktif</span></label>'+
          '</div>'+
          '<div class="modal-label">Status:</div><div class="modal-field">'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="gStatus" value="Ya"'+(bAktif?' checked':'')+' /> <span>Aktif</span></label>'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="gStatus" value="Tidak"'+(!bAktif?' checked':'')+' /> <span>Nonaktif</span></label>'+
          '</div>'+
        '</div>'
      ); }
      function dtlForm(o){ var sp=o.seqNo||o.noSoal||''; var np=(o.noPaket||selected.paket||''); var ng=(o.noGroup||selected.group||''); var nextUrut=(function(){ var m=0; (rawDtl||[]).forEach(function(r){ if(r && r.noUrut){ m=Math.max(m, r.noUrut); } }); return (m||0)+1; })(); var nu=o.noUrut||nextUrut; var jd=o.judul||''; var ds=o.deskripsi||''; var id=(o.isDownload||'Tidak'); var ak=(o.aktif||'Ya'); var um=o.urlMedia||''; var tm=o.tipeMedia||'NOMEDIA'; var ns=o.noSoal||''; var mapDisp=function(x){ x=(x||'').toUpperCase(); if(x==='NOMEDIA') return 'Tanpa Media'; if(x==='LINK'||x==='LINK MEDIA') return 'Link Media'; if(x==='UPLOAD'||x==='UPLOAD MEDIA') return 'Upload Media'; return 'Tanpa Media'; }; var disp=mapDisp(tm); var opt=function(v){ return '<label class="inline-flex items-center gap-2"><input type="radio" name="dTipeMedia" value="'+v+'"'+(mapDisp(v)===disp?' checked':'')+' /> <span>'+mapDisp(v)+'</span></label>'; }; return (
        '<div class="modal-form">'+
          '<div class="modal-label">Nomor Paket Soal:</div><div class="modal-field"><input id="dNoPaket" value="'+np+'" readonly /></div>'+
          '<div class="modal-label">Nomor Group Soal:</div><div class="modal-field"><input id="dNoGroup" value="'+ng+'" readonly /></div>'+
          '<div class="modal-label">Judul Pertanyaan:</div><div class="modal-field"><input id="dJudul" value="'+jd+'" /></div>'+
          '<div class="modal-label">Deskripsi Pertanyaan:</div><div class="modal-field" style="flex-direction:column; align-items:stretch;">'+
            '<div id="dToolbar" class="rt-toolbar" style="display:none">'+
              '<button type="button" data-cmd="bold" title="Bold"><b>B</b></button>'+
              '<button type="button" data-cmd="italic" title="Italic"><i>I</i></button>'+
              '<button type="button" data-cmd="underline" title="Underline"><u>U</u></button>'+
              '<button type="button" data-cmd="insertUnorderedList" title="Bullets">•</button>'+
              '<button type="button" data-cmd="insertOrderedList" title="Numbers">1.</button>'+
              '<button type="button" data-cmd="createLink" title="Link">🔗</button>'+
              '<button type="button" data-cmd="insertImage" title="Image">🖼️</button>'+
              '<button type="button" data-cmd="undo" title="Undo">↶</button>'+
              '<button type="button" data-cmd="redo" title="Redo">↷</button>'+
            '</div>'+
            '<textarea id="dDeskripsi">'+ds+'</textarea>'+
            '<div id="dDeskripsiRT" class="rt-area" contenteditable="true" style="display:none">'+(ds||'')+'</div>'+
          '</div>'+
          '<input id="dSeqNo" value="'+sp+'" style="display:none" />'+
          '<input id="dNoUrut" value="'+nu+'" style="display:none" />'+
          '<div class="modal-label">Type Media:</div><div class="modal-field media-types">'+ opt('NOMEDIA')+' '+ opt('LINK')+' '+ opt('UPLOAD') +'</div>'+
          '<div class="modal-label">Media:</div><div class="modal-field"><input id="dUrlMedia" value="'+(tm==='NOMEDIA'?'No Media':um)+'" '+(tm==='NOMEDIA'?'readonly':'')+' /></div>'+
          '<div class="modal-label"></div><div class="modal-field">'+
            '<input id="dUploadFile" type="file" accept="image/png,image/jpeg" style="display:none" />'+
            '<label for="dUploadFile" id="dUploadPlaceholder" class="upload-placeholder" style="display:'+(tm==='UPLOAD'?'flex':'none')+'"><span class="upload-title">Pilih gambar</span><span class="upload-hint">PNG/JPG, maks 2MB</span></label>'+
          '</div>'+
          '<div class="modal-label">Preview Gambar:</div><div class="modal-field"><div id="dPreview" class="upload-preview" style="display:'+(tm==='UPLOAD'?'block':'none')+'"><img id="dPreviewImg" alt="preview" style="max-width:100%; max-height:140px; display:'+(um?'block':'none')+'" src="'+(um||'')+'" /></div></div>'+
          '<div class="modal-label">IsDownload:</div><div class="modal-field">'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="dIsDownload" value="Ya"'+(id==='Ya'?' checked':'')+' /> <span>Aktif</span></label>'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="dIsDownload" value="Tidak"'+(id!=='Ya'?' checked':'')+' /> <span>Nonaktif</span></label>'+
          '</div>'+
          '<div class="modal-label">Status:</div><div class="modal-field">'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="dAktif" value="Ya"'+(ak==='Ya'?' checked':'')+' /> <span>Aktif</span></label>'+
            '<label class="inline-flex items-center gap-2"><input type="radio" name="dAktif" value="Tidak"'+(ak!=='Ya'?' checked':'')+' /> <span>Nonaktif</span></label>'+
          '</div>'+
          '<div class="modal-label"></div><div class="modal-field"><input id="dTipeMedia" value="'+tm+'" style="display:none" /></div>'+
          '<div class="modal-label"></div><div class="modal-field"><input id="dNoSoal" value="'+ns+'" style="display:none" /></div>'+
        '</div>'
      ); }
      function setupDtlFormInteractions(){
        var url = document.getElementById('dUrlMedia');
        var file = document.getElementById('dUploadFile');
        var placeholder = document.getElementById('dUploadPlaceholder');
        var preview = document.getElementById('dPreview');
        var img = document.getElementById('dPreviewImg');
        var setMode = function(mode){
          document.getElementById('dTipeMedia').value = mode;
          if(mode==='NOMEDIA'){
            if(url){ url.value=''; url.setAttribute('readonly','readonly'); }
            if(file){ file.style.display='none'; file.value=''; }
            if(placeholder){ placeholder.style.display='none'; }
            if(preview){ preview.style.display='none'; }
            if(img){ img.src=''; img.style.display='none'; }
          } else if(mode==='LINK'){
            if(url){ url.removeAttribute('readonly'); if(url.value==='No Media') url.value=''; }
            if(file){ file.style.display='none'; file.value=''; }
            if(placeholder){ placeholder.style.display='none'; }
            if(preview){ preview.style.display='none'; }
            if(img){ img.src=''; img.style.display='none'; }
          } else {
            if(url){ url.setAttribute('readonly','readonly'); url.value='No Media'; }
            if(file){ file.style.display='block'; }
            if(placeholder){ placeholder.style.display='flex'; }
            if(preview){ preview.style.display='block'; }
          }
        };
        var radios = document.querySelectorAll('input[name="dTipeMedia"]');
        radios.forEach(function(r){ r.addEventListener('change', function(){ setMode(this.value); }); });
        var current = (document.querySelector('input[name="dTipeMedia"]:checked')||{value:(document.getElementById('dTipeMedia').value||'NOMEDIA')}).value;
        setMode(current);
        if(file){
          file.addEventListener('change', function(){
            if(file.files && file.files[0]){
              if(!validateImageFile(file.files[0])){
                file.value='';
                if(img){ img.src=''; img.style.display='none'; }
                if(preview){ preview.style.display='block'; }
                return;
              }
              var reader=new FileReader();
              reader.onload=function(e){
                if(img){ img.src=e.target.result; img.style.display='block'; }
                if(preview){ preview.style.display='block'; }
              };
              reader.readAsDataURL(file.files[0]);
            } else {
              if(img){ img.src=''; img.style.display='none'; }
            }
          });
        }
        var enableFallback = function(){ var tb=document.getElementById('dToolbar'); var rt=document.getElementById('dDeskripsiRT'); var ta=document.getElementById('dDeskripsi'); if(tb) tb.style.display='flex'; if(rt) rt.style.display='block'; if(ta) ta.style.display='none'; if(tb){ tb.querySelectorAll('button[data-cmd]').forEach(function(b){ b.addEventListener('click', function(){ var cmd=this.getAttribute('data-cmd'); if(cmd==='createLink'){ var href=prompt('Masukkan URL'); if(href) document.execCommand(cmd,false,href); } else if(cmd==='insertImage'){ var src=prompt('Masukkan URL gambar'); if(src) document.execCommand(cmd,false,src); } else { document.execCommand(cmd,false,null); } }); }); } };
        if (!window.CKEDITOR){ var s=document.createElement('script'); s.src='https://cdn.ckeditor.com/4.25.1/standard/ckeditor.js'; document.head.appendChild(s); var to=setTimeout(function(){ enableFallback(); }, 800); s.onload=function(){ clearTimeout(to); try{ if(CKEDITOR.instances && CKEDITOR.instances.dDeskripsi){ CKEDITOR.instances.dDeskripsi.destroy(true); } setTimeout(function(){ CKEDITOR.replace('dDeskripsi', { height: 320 }); }, 50); }catch(e){ enableFallback(); } }; }
        else { try{ if(CKEDITOR.instances && CKEDITOR.instances.dDeskripsi){ CKEDITOR.instances.dDeskripsi.destroy(true); } setTimeout(function(){ CKEDITOR.replace('dDeskripsi', { height: 320 }); }, 50); }catch(e){ enableFallback(); } }
      }
      function setupJawabanFormInteractions(){
        var url=document.getElementById('jUrlMedia');
        var file=document.getElementById('jUploadFile');
        var placeholder=document.getElementById('jUploadPlaceholder');
        var preview=document.getElementById('jPreview');
        var img=document.getElementById('jPreviewImg');
        function setMode(mode){
          if(mode==='NOMEDIA'){
            if(url){ url.value=''; url.setAttribute('readonly','readonly'); }
            if(file){ file.style.display='none'; file.value=''; }
            if(placeholder){ placeholder.style.display='none'; }
            if(preview){ preview.style.display='none'; }
            if(img){ img.src=''; img.style.display='none'; }
          } else if(mode==='LINK'){
            if(url){ url.removeAttribute('readonly'); if(url.value==='No Media') url.value=''; }
            if(file){ file.style.display='none'; file.value=''; }
            if(placeholder){ placeholder.style.display='none'; }
            if(preview){ preview.style.display='none'; }
            if(img){ img.src=''; img.style.display='none'; }
          } else {
            if(url){ url.setAttribute('readonly','readonly'); url.value='No Media'; }
            if(file){ file.style.display='block'; }
            if(placeholder){ placeholder.style.display='flex'; }
            if(preview){ preview.style.display='block'; }
          }
        }
        var radios=document.querySelectorAll('input[name="jTipeMedia"]');
        radios.forEach(function(r){ r.addEventListener('change', function(){ setMode(this.value); }); });
        var current=(document.querySelector('input[name="jTipeMedia"]:checked')||{value:'NOMEDIA'}).value;
        setMode(current);
        if(file){
          file.addEventListener('change', function(){
            if(file.files && file.files[0]){
              if(!validateImageFile(file.files[0])){
                file.value='';
                if(img){ img.src=''; img.style.display='none'; }
                if(preview){ preview.style.display='block'; }
                return;
              }
              var reader=new FileReader();
              reader.onload=function(e){
                if(img){ img.src=e.target.result; img.style.display='block'; }
                if(preview){ preview.style.display='block'; }
              };
              reader.readAsDataURL(file.files[0]);
            } else {
              if(img){ img.src=''; img.style.display='none'; }
            }
          });
        }
      }
      function jawabanForm(o){ var sq=o.seqNo||''; var np=(o.noPaket||selected.paket||''); var ng=(o.noGroup||selected.group||''); var curDtl=(function(){ var idx=findByKey(rawDtl,'seqNo',selected.dtlSeqNo); if(idx<0) idx=findByKey(rawDtl,'noSoal',selected.dtlSeqNo); return idx>-1?rawDtl[idx]:null; })(); var nu=(o.noUrut||(curDtl?curDtl.noUrut:0)||0); var nextJwb=(function(){ var m=0; (rawJawaban||[]).forEach(function(r){ if(r && r.noJawaban){ m=Math.max(m, r.noJawaban); } }); return (m||0)+1; })(); var nj=o.noJawaban||nextJwb; var jw=o.jawaban||''; var pn=o.poin||0; var tm=(o.tipeMedia||'NOMEDIA'); var um=o.urlMedia||''; var txt=o.textMedia||''; var mapDisp=function(x){ x=(x||'').toUpperCase(); if(x==='NOMEDIA') return 'Tanpa Media'; if(x==='LINK'||x==='LINK MEDIA') return 'Link Media'; if(x==='UPLOAD'||x==='UPLOAD MEDIA') return 'Upload Media'; return 'Tanpa Media'; }; var disp=mapDisp(tm); var opt=function(v){ return '<label class="inline-flex items-center gap-2"><input type="radio" name="jTipeMedia" value="'+v+'"'+(mapDisp(v)===disp?' checked':'')+' /> <span>'+mapDisp(v)+'</span></label>'; }; return (
        '<div class="modal-form">'+
          '<div class="modal-label">Nomor Paket Soal:</div><div class="modal-field"><input id="jNoPaket" value="'+np+'" readonly /></div>'+
          '<div class="modal-label">Nomor Group Soal:</div><div class="modal-field"><input id="jNoGroup" value="'+ng+'" readonly /></div>'+
          '<div class="modal-label">Nomor Urut:</div><div class="modal-field"><input id="jNoUrut" type="number" class="w-24" value="'+nu+'" readonly /></div>'+
          '<div class="modal-label">Nomor Jawaban:</div><div class="modal-field"><input id="jNoJawaban" type="number" class="w-24" value="'+nj+'" /></div>'+
          '<div class="modal-label">Jawaban:</div><div class="modal-field"><textarea id="jJawaban" class="w-full">'+jw+'</textarea></div>'+
          '<div class="modal-label">Type Media:</div><div class="modal-field media-types">'+ opt('NOMEDIA')+' '+ opt('LINK')+' '+ opt('UPLOAD') +'</div>'+
          '<div class="modal-label">Media:</div><div class="modal-field"><input id="jUrlMedia" value="'+(tm==='NOMEDIA'?'No Media':um)+'" '+(tm==='NOMEDIA'?'readonly':'')+' /></div>'+
          '<div class="modal-label"></div><div class="modal-field">'+
            '<input id="jUploadFile" type="file" accept="image/png,image/jpeg" style="display:none" />'+
            '<label for="jUploadFile" id="jUploadPlaceholder" class="upload-placeholder" style="display:'+(tm==='UPLOAD'?'flex':'none')+'"><span class="upload-title">Pilih gambar</span><span class="upload-hint">PNG/JPG, maks 2MB</span></label>'+
          '</div>'+
          '<div class="modal-label">Preview Gambar:</div><div class="modal-field"><div id="jPreview" class="upload-preview" style="display:'+(tm==='UPLOAD'?'block':'none')+'"><img id="jPreviewImg" alt="preview" style="max-width:100%; max-height:140px; display:'+(um?'block':'none')+'" src="'+(um||'')+'" /></div></div>'+
          '<div class="modal-label">Text Media:</div><div class="modal-field"><input id="jTextMedia" value="'+txt+'" /></div>'+
          '<div class="modal-label">Poin:</div><div class="modal-field"><input id="jPoin" type="number" class="w-24" value="'+pn+'" /> <span>Poin</span></div>'+
          '<input id="jSeqNo" value="'+sq+'" style="display:none" />'+
        '</div>'
      ); }

      var qDateStart = document.getElementById('qDateStart');
      var qDateEnd = document.getElementById('qDateEnd');
      var qStatusPaket = document.getElementById('qStatusPaket');
      var btnQRefresh = document.getElementById('btnQRefresh');
      var btnQExport = document.getElementById('btnQExport');
      var pageSizePaket = document.getElementById('pageSizePaket');
      var pagerPaket = document.getElementById('pagerPaket');
      var pageNumsPaket = document.getElementById('pageNumsPaket');
      var infoPaket = document.getElementById('infoPaket');
      var tblBodyPaket = document.querySelector('#tblPaket tbody');

      var pageSizeGroup = document.getElementById('pageSizeGroup');
      var pagerGroup = document.getElementById('pagerGroup');
      var pageNumsGroup = document.getElementById('pageNumsGroup');
      var infoGroup = document.getElementById('infoGroup');
      var tblBodyGroup = document.querySelector('#tblGroup tbody');

      var pageSizeDtl = document.getElementById('pageSizeDtl');
      var pagerDtl = document.getElementById('pagerDtl');
      var pageNumsDtl = document.getElementById('pageNumsDtl');
      var infoDtl = document.getElementById('infoDtl');
      var tblBodyDtl = document.querySelector('#tblDtl tbody');

      var pageSizeJawaban = document.getElementById('pageSizeJawaban');
      var pagerJawaban = document.getElementById('pagerJawaban');
      var pageNumsJawaban = document.getElementById('pageNumsJawaban');
      var infoJawaban = document.getElementById('infoJawaban');
      var tblBodyJawaban = document.querySelector('#tblJawaban tbody');

      var titlePaket = document.getElementById('titlePaket');
      var gridPaket = document.getElementById('gridPaket');
      var titleGroup = document.getElementById('titleGroup');
      var gridGroup = document.getElementById('gridGroup');
      var titleDtl = document.getElementById('titleDtl');
      var gridDtl = document.getElementById('gridDtl');
      var titleJawaban = document.getElementById('titleJawaban');
      var gridJawaban = document.getElementById('gridJawaban');

      var rawPaket = [];
      var rawGroup = [];
      var rawDtl = [];
      var rawJawaban = [];
      var selected = { paket:null, group:null, dtlSeqNo:null };

      var searchPaket = {}; var sortPaket = { field:null, dir:1 }; var currentPagePaket = 1;
      var searchGroup = {}; var sortGroup = { field:null, dir:1 }; var currentPageGroup = 1;
      var searchDtl = {}; var sortDtl = { field:null, dir:1 }; var currentPageDtl = 1;
      var searchJawaban = {}; var sortJawaban = { field:null, dir:1 }; var currentPageJawaban = 1;

      var today = new Date(); var start = new Date(today.getFullYear(), today.getMonth()-1, today.getDate());
      qDateStart.value = toISODate(start); qDateEnd.value = toISODate(today);
      enhanceDateInput(qDateStart); enhanceDateInput(qDateEnd);

      function updateSortUI(scope, sort){
        document.querySelectorAll(scope+' .sort-icons').forEach(function(si){ var asc=si.querySelector('.asc'); var desc=si.querySelector('.desc'); var f=si.getAttribute('data-sort'); asc.classList.remove('active'); desc.classList.remove('active'); if(sort.field===f){ if(sort.dir===1) asc.classList.add('active'); else desc.classList.add('active'); } });
      }

      function fetchPaket(){
        var s=qDateStart.value; var e=qDateEnd.value; var st=qStatusPaket.value;
        var url='@Url.Content("~/Questions/Paket/List")'+'?fromDate='+encodeURIComponent(s)+'&toDate='+encodeURIComponent(e)+'&status='+encodeURIComponent(st);
        var sc=document.querySelector('#tblPaket')?document.querySelector('#tblPaket').closest('.table-scroll'):null; if(sc) sc.classList.add('loading');
        return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(j){ rawPaket=(j||[]).map(function(x){ return { num:0, noPaket:x.noPaket, namaPaket:x.namaPaket, posisi:(x.posisi||x.position||''), toleransi:x.toleransi, status:x.status, userInput:x.userInput, time:x.time, userEdit:x.userEdit, timeEdit:x.timeEdit }; }); rawPaket.forEach(function(x,i){ x.num=i+1; }); currentPagePaket=1; applyPaket(); }).then(function(){ if(rawPaket && rawPaket.length>0){ selected.paket=rawPaket[0].noPaket; setSingleSelection('#tblPaket', selected.paket); return fetchGroup(selected.paket).then(function(){ if(rawGroup && rawGroup.length>0){ selected.group=rawGroup[0].noGroup; setSingleSelection('#tblGroup', selected.group); return fetchDtl(selected.paket, selected.group).then(function(){ if(rawDtl && rawDtl.length>0){ selected.dtlSeqNo=rawDtl[0].seqNo||rawDtl[0].noSoal; setSingleSelection('#tblDtl', rawDtl[0].noSoal); var nu=rawDtl[0].noUrut; return fetchJawaban(selected.paket, selected.group, nu); } else { rawJawaban=[]; applyJawaban(); } }); } else { rawDtl=[]; applyDtl(); rawJawaban=[]; applyJawaban(); } }); } else { rawGroup=[]; applyGroup(); rawDtl=[]; applyDtl(); rawJawaban=[]; applyJawaban(); } }).catch(function(err){ console.error('Paket chain error', err); }).finally(function(){ if(sc) sc.classList.remove('loading'); });
      }
      function fetchGroup(noPaket){
        if(!noPaket){ rawGroup=[]; applyGroup(); return Promise.resolve(); }
        var url='@Url.Content("~/Questions/Group/List")'+'?noPaket='+encodeURIComponent(parseInt(noPaket,10)||0);
        var sc=document.querySelector('#tblGroup')?document.querySelector('#tblGroup').closest('.table-scroll'):null; if(sc) sc.classList.add('loading');
        return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(j){ rawGroup=(j||[]).map(function(x){ var pid=x.petunjuk; return { num:0, noGroup:x.noGroup, namaGroup:x.namaGroup, minSoal:x.minSoal, nilaiStandar:x.nilaiStandar, waktu:x.waktu, random:x.random, status:x.status, petunjukId:pid, petunjuk:getPetunjukLabel(pid), userInput:x.userInput, time:x.time, userEdit:x.userEdit, timeEdit:x.timeEdit, isPrioritas:!!x.isPrioritas }; }); rawGroup.forEach(function(x,i){ x.num=i+1; }); currentPageGroup=1; applyGroup(); }).catch(function(err){ console.error('Group load error', err); infoGroup.textContent='Gagal memuat data Group'; }).finally(function(){ if(sc) sc.classList.remove('loading'); });
      }
      function fetchDtl(noPaket,noGroup){
        if(!noPaket || !noGroup){ rawDtl=[]; applyDtl(); return Promise.resolve(); }
        var url='@Url.Content("~/Questions/Detail/List")'+'?noPaket='+encodeURIComponent(parseInt(noPaket,10)||0)+'&noGroup='+encodeURIComponent(parseInt(noGroup,10)||0);
        var sc=document.querySelector('#tblDtl')?document.querySelector('#tblDtl').closest('.table-scroll'):null; if(sc) sc.classList.add('loading');
        return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(j){ rawDtl=(j||[]).map(function(x){ return { num:0, seqNo:x.seqNo, noUrut:x.noUrut, judul:x.judul, deskripsi:x.deskripsi, isDownload:x.isDownload, aktif:x.aktif, urlMedia:x.urlMedia, tipeMedia:x.tipeMedia, userInput:x.userInput, time:x.time, userEdit:x.userEdit, timeEdit:x.timeEdit, noSoal:x.noSoal }; }); rawDtl.forEach(function(x,i){ x.num=i+1; }); currentPageDtl=1; applyDtl(); }).catch(function(err){ console.error('Dtl load error', err); infoDtl.textContent='Gagal memuat data Pertanyaan'; }).finally(function(){ if(sc) sc.classList.remove('loading'); });
      }
      function fetchJawaban(noPaket,noGroup,noUrut){
        if(!noPaket || !noGroup || !noUrut){ rawJawaban=[]; applyJawaban(); return Promise.resolve(); }
        var url='@Url.Content("~/Questions/Answer/List")'+'?noPaket='+encodeURIComponent(parseInt(noPaket,10)||0)+'&noGroup='+encodeURIComponent(parseInt(noGroup,10)||0)+'&noUrut='+encodeURIComponent(parseInt(noUrut,10)||0);
        var sc=document.querySelector('#tblJawaban')?document.querySelector('#tblJawaban').closest('.table-scroll'):null; if(sc) sc.classList.add('loading');
        return fetch(url,{ method:'GET', credentials:'same-origin' }).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(j){ rawJawaban=(j||[]).map(function(x){ return { num:0, seqNo:x.seqNo, noJawaban:x.noJawaban, jawaban:x.jawaban, poin:x.poin, tipeMedia:x.tipeMedia, urlMedia:x.urlMedia, userInput:x.userInput, time:x.time, userEdit:x.userEdit, timeEdit:x.timeEdit }; }); rawJawaban.forEach(function(x,i){ x.num=i+1; }); currentPageJawaban=1; applyJawaban(); }).catch(function(err){ console.error('Jawaban load error', err); infoJawaban.textContent='Gagal memuat data Jawaban'; }).finally(function(){ if(sc) sc.classList.remove('loading'); });
      }

      function renderPages(el, totalPages, current){ el.innerHTML=''; var mk=function(n,a){ var b=document.createElement('button'); b.className='page-btn btn-flat px-2 py-1 rounded-md'+(a?' bg-white':''); b.textContent=n; b.dataset.page=n; el.appendChild(b); }; if(totalPages<=5){ for(var i=1;i<=totalPages;i++) mk(i, i===current); return; } mk(1,current===1); mk(2,current===2); mk(3,current===3); var ell=document.createElement('span'); ell.textContent='...'; ell.className='text-gray-500 px-1'; el.appendChild(ell); mk(totalPages,current===totalPages); }

      function applyPaket(){
        var s=qDateStart.value; var e=qDateEnd.value; var st=qStatusPaket.value;
        var rows = rawPaket.filter(function(x){ var okDate = !s || !e || within(new Date(x.time), s, e); var okSt = !st || (st==='AKTIF' ? x.status==='AKTIF' : x.status==='NONAKTIF'); var okSearch = true; Object.keys(searchPaket).forEach(function(k){ var v=(searchPaket[k]||'').toLowerCase(); if(v){ var xv=(''+x[k]).toLowerCase(); if(k==='time' || k==='timeEdit'){ xv = fmtDateTime(new Date(x[k==='time'?'time':'timeEdit'])).toLowerCase(); } if(xv.indexOf(v)===-1) okSearch=false; } }); return okDate && okSt && okSearch; });
        if(sortPaket.field){ rows.sort(function(a,b){ var av=a[sortPaket.field]; var bv=b[sortPaket.field]; if(sortPaket.field==='time' || sortPaket.field==='timeEdit'){ av=new Date(sortPaket.field==='time'?a.time:a.timeEdit).getTime(); bv=new Date(sortPaket.field==='time'?b.time:b.timeEdit).getTime(); } if(av<bv) return -1*sortPaket.dir; if(av>bv) return 1*sortPaket.dir; return 0; }); }
        var pageSize = parseInt(pageSizePaket.value,10)||10; var total=rows.length; var totalPages=Math.max(1, Math.ceil(total/pageSize)); if(currentPagePaket>totalPages) currentPagePaket=totalPages; var start=(currentPagePaket-1)*pageSize; var pageRows=rows.slice(start, start+pageSize);
        tblBodyPaket.innerHTML=''; pageRows.forEach(function(r){
          var tr=document.createElement('tr');
          tr.setAttribute('data-key', r.noPaket);

          var tdSel = document.createElement('td');
          tdSel.className = 'px-3 py-1 cell select-cell';
          tdSel.innerHTML = '<div class="select-square" data-key="'+r.noPaket+'"></div>';
          tr.appendChild(tdSel);

          var tdEdit = document.createElement('td');
          tdEdit.className = 'px-1 py-1 cell';
          tdEdit.appendChild(makeEditButton('paket', r.noPaket, 'tblPaket:' + r.noPaket));
          tr.appendChild(tdEdit);

          tr.insertAdjacentHTML('beforeend',
            '<td class="px-1 py-1 cell">'+r.num+'</td>'+
            '<td class="px-1 py-1 cell">'+r.noPaket+'</td>'+
            '<td class="px-1 py-1 cell">'+r.namaPaket+'</td>'+
            '<td class="px-1 py-1 cell">'+r.posisi+'</td>'+
            '<td class="px-1 py-1 cell">'+r.toleransi+'</td>'+
            '<td class="px-1 py-1 cell">'+r.status+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userInput+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.time))+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userEdit+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.timeEdit))+'</td>'
          );

          tblBodyPaket.appendChild(tr);
        });
        infoPaket.textContent='Showing '+(start+1)+' to '+Math.min(start+pageSize,total)+' of '+total+' entries';
        renderPages(pageNumsPaket, Math.max(1, Math.ceil(total/pageSize)), currentPagePaket);
        updateSortUI('#tblPaket', sortPaket);
        setSingleSelection('#tblPaket', selected.paket);
      }

      function applyGroup(){
        var rows = rawGroup.filter(function(x){ var okSearch = true; Object.keys(searchGroup).forEach(function(k){ var v=(searchGroup[k]||'').toLowerCase(); if(v){ var xv=(''+x[k]).toLowerCase(); if(k==='time' || k==='timeEdit'){ xv = fmtDateTime(new Date(x[k==='time'?'time':'timeEdit'])).toLowerCase(); } if(xv.indexOf(v)===-1) okSearch=false; } }); return okSearch; });
        if(sortGroup.field){ rows.sort(function(a,b){ var av=a[sortGroup.field]; var bv=b[sortGroup.field]; if(sortGroup.field==='time' || sortGroup.field==='timeEdit'){ av=new Date(sortGroup.field==='time'?a.time:a.timeEdit).getTime(); bv=new Date(sortGroup.field==='time'?b.time:b.timeEdit).getTime(); } if(av<bv) return -1*sortGroup.dir; if(av>bv) return 1*sortGroup.dir; return 0; }); }
        var pageSize = parseInt(pageSizeGroup.value,10)||10; var total=rows.length; var totalPages=Math.max(1, Math.ceil(total/pageSize)); if(currentPageGroup>totalPages) currentPageGroup=totalPages; var start=(currentPageGroup-1)*pageSize; var pageRows=rows.slice(start, start+pageSize);
        tblBodyGroup.innerHTML=''; pageRows.forEach(function(r){
          var tr=document.createElement('tr');
          tr.setAttribute('data-key', r.noGroup);

          var tdSel = document.createElement('td');
          tdSel.className = 'px-3 py-1 cell select-cell';
          tdSel.innerHTML = '<div class="select-square" data-key="'+r.noGroup+'"></div>';
          tr.appendChild(tdSel);

          var tdEdit = document.createElement('td');
          tdEdit.className = 'px-1 py-1 cell';
          tdEdit.appendChild(makeEditButton('group', r.noGroup, 'tblGroup:' + r.noGroup));
          tr.appendChild(tdEdit);

          tr.insertAdjacentHTML('beforeend',
            '<td class="px-1 py-1 cell">'+r.num+'</td>'+
            '<td class="px-1 py-1 cell">'+r.noGroup+'</td>'+
            '<td class="px-1 py-1 cell">'+r.namaGroup+'</td>'+
            '<td class="px-1 py-1 cell">'+r.minSoal+'</td>'+
            '<td class="px-1 py-1 cell">'+r.nilaiStandar+'</td>'+
            '<td class="px-1 py-1 cell">'+r.waktu+'</td>'+
            '<td class="px-1 py-1 cell">'+r.random+'</td>'+
            '<td class="px-1 py-1 cell">'+r.status+'</td>'+
            '<td class="px-1 py-1 cell">'+r.petunjuk+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userInput+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.time))+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userEdit+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.timeEdit))+'</td>'
          );

          tblBodyGroup.appendChild(tr);
        });
        infoGroup.textContent='Showing '+(start+1)+' to '+Math.min(start+pageSize,total)+' of '+total+' entries';
        renderPages(pageNumsGroup, Math.max(1, Math.ceil(total/pageSize)), currentPageGroup);
        updateSortUI('#tblGroup', sortGroup);
        setSingleSelection('#tblGroup', selected.group);
      }

      function applyDtl(){
        var rows = rawDtl.filter(function(x){ var okSearch = true; Object.keys(searchDtl).forEach(function(k){ var v=(searchDtl[k]||'').toLowerCase(); if(v){ var xv=(''+x[k]).toLowerCase(); if(k==='time' || k==='timeEdit'){ xv = fmtDateTime(new Date(x[k==='time'?'time':'timeEdit'])).toLowerCase(); } if(xv.indexOf(v)===-1) okSearch=false; } }); return okSearch; });
        if(sortDtl.field){ rows.sort(function(a,b){ var av=a[sortDtl.field]; var bv=b[sortDtl.field]; if(sortDtl.field==='time' || sortDtl.field==='timeEdit'){ av=new Date(sortDtl.field==='time'?a.time:a.timeEdit).getTime(); bv=new Date(sortDtl.field==='time'?b.time:b.timeEdit).getTime(); } if(av<bv) return -1*sortDtl.dir; if(av>bv) return 1*sortDtl.dir; return 0; }); }
        var pageSize = parseInt(pageSizeDtl.value,10)||10; var total=rows.length; var totalPages=Math.max(1, Math.ceil(total/pageSize)); if(currentPageDtl>totalPages) currentPageDtl=totalPages; var start=(currentPageDtl-1)*pageSize; var pageRows=rows.slice(start, start+pageSize);
        tblBodyDtl.innerHTML=''; pageRows.forEach(function(r){
          var tr=document.createElement('tr');
          tr.setAttribute('data-key', r.noSoal);

          var tdSel = document.createElement('td');
          tdSel.className = 'px-3 py-1 cell select-cell';
          tdSel.innerHTML = '<div class="select-square" data-key="'+r.noSoal+'"></div>';
          tr.appendChild(tdSel);

          var tdEdit = document.createElement('td');
          tdEdit.className = 'px-1 py-1 cell';
          tdEdit.appendChild(makeEditButton('dtl', r.noSoal, 'tblDtl:' + r.noSoal));
          tr.appendChild(tdEdit);

          tr.insertAdjacentHTML('beforeend',
            '<td class="px-1 py-1 cell">'+r.num+'</td>'+
            '<td class="px-1 py-1 cell">'+r.noUrut+'</td>'+
            '<td class="px-1 py-1 cell">'+r.judul+'</td>'+
            '<td class="px-1 py-1 cell">'+r.deskripsi+'</td>'+
            '<td class="px-1 py-1 cell">'+r.isDownload+'</td>'+
            '<td class="px-1 py-1 cell">'+r.aktif+'</td>'+
            '<td class="px-1 py-1 cell">'+r.urlMedia+'</td>'+
            '<td class="px-1 py-1 cell">'+r.tipeMedia+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userInput+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.time))+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userEdit+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.timeEdit))+'</td>'+
            '<td class="px-1 py-1 cell">'+r.noSoal+'</td>'
          );

          tblBodyDtl.appendChild(tr);
        });
        infoDtl.textContent='Showing '+(start+1)+' to '+Math.min(start+pageSize,total)+' of '+total+' entries';
        renderPages(pageNumsDtl, Math.max(1, Math.ceil(total/pageSize)), currentPageDtl);
        updateSortUI('#tblDtl', sortDtl);
        var kDtl = null;
        if(selected.dtlSeqNo){
          var iDtl = findByKey(rawDtl,'seqNo',selected.dtlSeqNo);
          if(iDtl===-1) iDtl = findByKey(rawDtl,'noSoal',selected.dtlSeqNo);
          if(iDtl>-1) kDtl = rawDtl[iDtl].noSoal;
          else kDtl = selected.dtlSeqNo;
        }
        setSingleSelection('#tblDtl', kDtl);
      }

      function applyJawaban(){
        var rows = rawJawaban.filter(function(x){ var okSearch = true; Object.keys(searchJawaban).forEach(function(k){ var v=(searchJawaban[k]||'').toLowerCase(); if(v){ var xv=(''+x[k]).toLowerCase(); if(k==='time' || k==='timeEdit'){ xv = fmtDateTime(new Date(x[k==='time'?'time':'timeEdit'])).toLowerCase(); } if(xv.indexOf(v)===-1) okSearch=false; } }); return okSearch; });
        if(sortJawaban.field){ rows.sort(function(a,b){ var av=a[sortJawaban.field]; var bv=b[sortJawaban.field]; if(sortJawaban.field==='time' || sortJawaban.field==='timeEdit'){ av=new Date(sortJawaban.field==='time'?a.time:a.timeEdit).getTime(); bv=new Date(sortJawaban.field==='time'?b.time:b.timeEdit).getTime(); } if(av<bv) return -1*sortJawaban.dir; if(av>bv) return 1*sortJawaban.dir; return 0; }); }
        var pageSize = parseInt(pageSizeJawaban.value,10)||10; var total=rows.length; var totalPages=Math.max(1, Math.ceil(total/pageSize)); if(currentPageJawaban>totalPages) currentPageJawaban=totalPages; var start=(currentPageJawaban-1)*pageSize; var pageRows=rows.slice(start, start+pageSize);
        tblBodyJawaban.innerHTML=''; pageRows.forEach(function(r){
          var tr=document.createElement('tr');
          tr.setAttribute('data-key', r.seqNo);

          var tdSel = document.createElement('td');
          tdSel.className = 'px-3 py-1 cell select-cell';
          tdSel.innerHTML = '<div class="select-square" data-key="'+r.seqNo+'"></div>';
          tr.appendChild(tdSel);

          var tdEdit = document.createElement('td');
          tdEdit.className = 'px-1 py-1 cell';
          tdEdit.appendChild(makeEditButton('jawaban', r.seqNo, 'tblJawaban:' + r.seqNo));
          tr.appendChild(tdEdit);

          tr.insertAdjacentHTML('beforeend',
            '<td class="px-1 py-1 cell">'+r.num+'</td>'+
            '<td class="px-1 py-1 cell">'+r.noJawaban+'</td>'+
            '<td class="px-1 py-1 cell">'+r.jawaban+'</td>'+
            '<td class="px-1 py-1 cell">'+r.poin+'</td>'+
            '<td class="px-1 py-1 cell">'+r.tipeMedia+'</td>'+
            '<td class="px-1 py-1 cell">'+r.urlMedia+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userInput+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.time))+'</td>'+
            '<td class="px-1 py-1 cell">'+r.userEdit+'</td>'+
            '<td class="px-1 py-1 cell">'+fmtDateTime(new Date(r.timeEdit))+'</td>'+
            '<td class="px-1 py-1 cell">'+r.seqNo+'</td>'
          );

          tblBodyJawaban.appendChild(tr);
        });
        infoJawaban.textContent='Showing '+(start+1)+' to '+Math.min(start+pageSize,total)+' of '+total+' entries';
        renderPages(pageNumsJawaban, Math.max(1, Math.ceil(total/pageSize)), currentPageJawaban);
        updateSortUI('#tblJawaban', sortJawaban);
      }

      document.querySelectorAll('.col-search-paket').forEach(function(el){ el.addEventListener('input', function(){ searchPaket[el.dataset.field]=el.value; currentPagePaket=1; applyPaket(); }); });
      document.querySelectorAll('#tblPaket .sort-icons .asc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortPaket.field=f; sortPaket.dir=1; applyPaket(); }); });
      document.querySelectorAll('#tblPaket .sort-icons .desc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortPaket.field=f; sortPaket.dir=-1; applyPaket(); }); });
      pageSizePaket.addEventListener('change', function(){ currentPagePaket=1; applyPaket(); });
      pagerPaket.addEventListener('click', function(e){ var t=e.target; if(!t.classList.contains('page-btn')) return; var p=t.dataset.page; if(p==='prev'){ currentPagePaket=Math.max(1,currentPagePaket-1); } else if(p==='next'){ currentPagePaket=currentPagePaket+1; } else { currentPagePaket=parseInt(p,10)||1; } applyPaket(); });
      btnQRefresh.addEventListener('click', function(){ fetchPaket(); });
      function exportPaketXlsx(){
        var s=qDateStart.value; var e=qDateEnd.value; var st=qStatusPaket.value;
        var url='@Url.Content("~/Questions/Paket/Export")'+'?fromDate='+encodeURIComponent(s||'')+'&toDate='+encodeURIComponent(e||'')+'&status='+encodeURIComponent(st||'');
        window.open(url, '_blank');
      }
      btnQExport.addEventListener('click', exportPaketXlsx);

      function setSingleSelection(scope, key){
        var body = document.querySelector(scope+' tbody');
        if(!body) return;
        body.querySelectorAll('tr').forEach(function(tr){
          tr.classList.remove('row-active');
          var sq = tr.querySelector('.select-square');
          if(sq) sq.classList.remove('selected');
        });
        if(!key) return;
        var target = null;
        body.querySelectorAll('tr').forEach(function(tr){
          if((''+tr.getAttribute('data-key')) === (''+key)) target = tr;
        });
        if(target){
          target.classList.add('row-active');
          var sq = target.querySelector('.select-square');
          if(sq) sq.classList.add('selected');
        }
      }
      function wireSelect(scope, selectAllId, onChange){
        var body=document.querySelector(scope+' tbody');
        var all=document.getElementById(selectAllId);
        if(body){
          body.addEventListener('click', function(e){
            if(e.target.closest('.row-edit-btn')) return;
            var tr = e.target.closest('tr');
            if(!tr) return;
            var key = tr.getAttribute('data-key');
            if(!key) return;
            if(all) all.classList.remove('selected');
            setSingleSelection(scope, key);
            if(onChange) onChange(scope, key, true);
          });
        }
        if(all){
          all.addEventListener('click', function(){
            all.classList.remove('selected');
            setSingleSelection(scope, null);
            if(onChange) onChange(scope, null, false);
          });
        }
      }
      function getSelectedKeys(scope){ var arr=[]; document.querySelectorAll(scope+' tbody .select-square.selected').forEach(function(el){ var k=el.getAttribute('data-key'); if(k) arr.push(k); }); return arr; }
      qStatusPaket.addEventListener('change', function(){ fetchPaket(); });
      qDateStart.addEventListener('change', function(){ fetchPaket(); });
      qDateEnd.addEventListener('change', function(){ fetchPaket(); });

      document.querySelectorAll('.col-search-group').forEach(function(el){ el.addEventListener('input', function(){ searchGroup[el.dataset.field]=el.value; currentPageGroup=1; applyGroup(); }); });
      document.querySelectorAll('#tblGroup .sort-icons .asc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortGroup.field=f; sortGroup.dir=1; applyGroup(); }); });
      document.querySelectorAll('#tblGroup .sort-icons .desc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortGroup.field=f; sortGroup.dir=-1; applyGroup(); }); });
      pageSizeGroup.addEventListener('change', function(){ currentPageGroup=1; applyGroup(); });
      pagerGroup.addEventListener('click', function(e){ var t=e.target; if(!t.classList.contains('page-btn')) return; var p=t.dataset.page; if(p==='prev'){ currentPageGroup=Math.max(1,currentPageGroup-1); } else if(p==='next'){ currentPageGroup=currentPageGroup+1; } else { currentPageGroup=parseInt(p,10)||1; } applyGroup(); });

      document.querySelectorAll('.col-search-dtl').forEach(function(el){ el.addEventListener('input', function(){ searchDtl[el.dataset.field]=el.value; currentPageDtl=1; applyDtl(); }); });
      document.querySelectorAll('#tblDtl .sort-icons .asc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortDtl.field=f; sortDtl.dir=1; applyDtl(); }); });
      document.querySelectorAll('#tblDtl .sort-icons .desc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortDtl.field=f; sortDtl.dir=-1; applyDtl(); }); });
      pageSizeDtl.addEventListener('change', function(){ currentPageDtl=1; applyDtl(); });
      pagerDtl.addEventListener('click', function(e){ var t=e.target; if(!t.classList.contains('page-btn')) return; var p=t.dataset.page; if(p==='prev'){ currentPageDtl=Math.max(1,currentPageDtl-1); } else if(p==='next'){ currentPageDtl=currentPageDtl+1; } else { currentPageDtl=parseInt(p,10)||1; } applyDtl(); });

      document.querySelectorAll('.col-search-jawaban').forEach(function(el){ el.addEventListener('input', function(){ searchJawaban[el.dataset.field]=el.value; currentPageJawaban=1; applyJawaban(); }); });
      document.querySelectorAll('#tblJawaban .sort-icons .asc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortJawaban.field=f; sortJawaban.dir=1; applyJawaban(); }); });
      document.querySelectorAll('#tblJawaban .sort-icons .desc').forEach(function(el){ el.addEventListener('click', function(){ var f=el.parentElement.getAttribute('data-sort'); sortJawaban.field=f; sortJawaban.dir=-1; applyJawaban(); }); });
      pageSizeJawaban.addEventListener('change', function(){ currentPageJawaban=1; applyJawaban(); });
      pagerJawaban.addEventListener('click', function(e){ var t=e.target; if(!t.classList.contains('page-btn')) return; var p=t.dataset.page; if(p==='prev'){ currentPageJawaban=Math.max(1,currentPageJawaban-1); } else if(p==='next'){ currentPageJawaban=currentPageJawaban+1; } else { currentPageJawaban=parseInt(p,10)||1; } applyJawaban(); });

      
      function getSelectedIds(scope){ var ids=[]; document.querySelectorAll(scope+' tbody .select-square.selected').forEach(function(){ ids.push(true); }); return ids; }
      function toast(msg){ console.log(msg); }
      function showFailed(msg){
        if(window.DCT3Modals && typeof DCT3Modals.open === 'function'){
          DCT3Modals.open('failed', { message: msg || '' });
        } else {
          alert(msg || '');
        }
      }
      function validateImageFile(file){
        if(!file) return false;
        var name=(file.name||'').toLowerCase();
        var type=(file.type||'').toLowerCase();
        var okType=(type==='image/png' || type==='image/jpeg' || name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg'));
        if(!okType){ showFailed('Format gambar harus PNG, JPG atau JPEG'); return false; }
        if(file.size>2*1024*1024){ showFailed('Maks size file harus 2mb'); return false; }
        return true;
      }
      function ModalAlert(msg){
        if(window.DCT3Modals && typeof DCT3Modals.open === 'function'){
          DCT3Modals.open('alert', { message: msg || '' });
        } else {
          openModal('Alert', '<div>'+(msg||'')+'</div>', null);
        }
      }
      function isAktifStatus(v){ return (''+(v||'')).toUpperCase()==='AKTIF'; }
      function isYa(v){ return (''+(v||'')).toUpperCase()==='YA'; }
      function getSelectedPaketObj(){ var i=findByKey(rawPaket,'noPaket',selected.paket); return i>-1?rawPaket[i]:null; }
      function getSelectedGroupObj(){ var i=findByKey(rawGroup,'noGroup',selected.group); return i>-1?rawGroup[i]:null; }
      function getSelectedDtlObj(){
        var i=findByKey(rawDtl,'seqNo',selected.dtlSeqNo); if(i===-1) i=findByKey(rawDtl,'noSoal',selected.dtlSeqNo);
        return i>-1?rawDtl[i]:null;
      }

      (function(){
        var btnAddGroup = document.getElementById('btnAddGroup');
        if(btnAddGroup){
          btnAddGroup.addEventListener('click', function(e){
            var p = getSelectedPaketObj();
            if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Tidak dapat menambahkan atau menghapus Group Soal karena Paket Soal sedang aktif'); }
          }, true);
        }
        var btnDeleteGroup = document.getElementById('btnDeleteGroup');
        if(btnDeleteGroup){
          btnDeleteGroup.addEventListener('click', function(e){
            var p = getSelectedPaketObj();
            if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Tidak dapat menambahkan atau menghapus Group Soal karena Paket Soal sedang aktif'); }
          }, true);
        }
        var btnAddDtl = document.getElementById('btnAddDtl');
        if(btnAddDtl){
          btnAddDtl.addEventListener('click', function(e){
            var p = getSelectedPaketObj();
            if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Tidak dapat menambahkan atau menghapus Pertanyaan karena Paket Soal sedang aktif'); }
          }, true);
        }
        var btnDeleteDtl = document.getElementById('btnDeleteDtl');
        if(btnDeleteDtl){
          btnDeleteDtl.addEventListener('click', function(e){
            var p = getSelectedPaketObj();
            if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Tidak dapat menambahkan atau menghapus Pertanyaan karena Paket Soal sedang aktif'); }
          }, true);
        }
        var btnAddJawaban = document.getElementById('btnAddJawaban');
        if(btnAddJawaban){
          btnAddJawaban.addEventListener('click', function(e){
            var p = getSelectedPaketObj();
            if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Tidak dapat menambahkan atau menghapus Jawaban karena Paket Soal sedang aktif'); }
          }, true);
        }
        var btnDeleteJawaban = document.getElementById('btnDeleteJawaban');
        if(btnDeleteJawaban){
          btnDeleteJawaban.addEventListener('click', function(e){
            var p = getSelectedPaketObj();
            if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Tidak dapat menambahkan atau menghapus Jawaban karena Paket Soal sedang aktif'); }
          }, true);
        }

        var paketBody = document.querySelector('#tblPaket tbody');
        if(paketBody){
          paketBody.addEventListener('click', function(e){
            var b = e.target.closest('.row-edit-btn');
            if(!b) return;
            var key = b.getAttribute('data-key');
          }, true);
        }
        var groupBody = document.querySelector('#tblGroup tbody');
        if(groupBody){
          groupBody.addEventListener('click', function(e){
            var b = e.target.closest('.row-edit-btn');
            if(!b) return;
            var key = b.getAttribute('data-key');
            var i = findByKey(rawGroup,'noGroup',key);
            var p = getSelectedPaketObj();
            if(i>-1 && p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Data yang status Paket Soalnya Aktif tidak dapat di edit'); }
          }, true);
        }
        var dtlBody = document.querySelector('#tblDtl tbody');
        if(dtlBody){
          dtlBody.addEventListener('click', function(e){
            var b = e.target.closest('.row-edit-btn');
            if(!b) return;
            var key = b.getAttribute('data-key');
            var i = findByKey(rawDtl,'seqNo',key);
            if(i===-1) i = findByKey(rawDtl,'noSoal',key);
            var p = getSelectedPaketObj();
            if(i>-1 && p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Data yang status Paket Soalnya Aktif tidak dapat di edit'); }
          }, true);
        }
      })();
      document.getElementById('btnAddPaket').addEventListener('click', function(){ var o={}; openModal('Tambah Paket Soal', paketForm(o), function(){ var na=(document.getElementById('fNamaPaket').value||'').trim(); var to=parseInt(document.getElementById('fToleransi').value||'0',10); var st=(document.querySelector('input[name="fStatus"]:checked')||{value:'AKTIF'}).value; var pos=normalizePosList((document.getElementById('fPosition').value||'').trim()).join(','); fetch('@Url.Content("~/Questions/Paket/Add")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NamaPaket:na, ToleransiWaktu:to, Status:st, Position:pos, User:'@User.Identity?.Name' }) }).then(function(r){ return r.json().then(function(data){ if(!r.ok){ toast((data&&data.error)||'Gagal tambah paket'); return; } fetchPaket(); }); }); }); });
      wireSelect('#tblPaket','selectAllPaket', function(scope,key,sel){
        selected.paket=key;
        fetchGroup(selected.paket).then(function(){
          if(rawGroup && rawGroup.length>0){
            selected.group=rawGroup[0].noGroup;
            setSingleSelection('#tblGroup', selected.group);
            return fetchDtl(selected.paket, selected.group).then(function(){
              if(rawDtl && rawDtl.length>0){
                selected.dtlSeqNo=rawDtl[0].seqNo||rawDtl[0].noSoal;
                setSingleSelection('#tblDtl', rawDtl[0].noSoal);
                var nu=rawDtl[0].noUrut;
                return fetchJawaban(selected.paket, selected.group, nu);
              } else {
                rawJawaban=[]; applyJawaban();
              }
            });
          } else {
            selected.group=null;
            rawDtl=[]; applyDtl();
            selected.dtlSeqNo=null;
            rawJawaban=[]; applyJawaban();
          }
        });
      });

      document.getElementById('btnAddGroup').addEventListener('click', function(){ if(!selected.paket){ openModal('Informasi', '<div>Pilih Paket terlebih dahulu.</div>', null); return; } var o={ noPaket:selected.paket }; ensurePetunjuk().then(function(){ openModal('Tambah Group Soal', groupForm(o), function(){ var np=parseInt(selected.paket||'0',10); var nm=(document.getElementById('gNamaGroup').value||'').trim(); var ms=parseInt(document.getElementById('gMinSoal').value||'0',10)||0; var ns=parseInt(document.getElementById('gNilaiStandar').value||'0',10)||0; var w=parseInt(document.getElementById('gWaktu').value||'0',10)||0; var pjVal=(document.getElementById('gNoPetunjuk').value||''); var pj=parseInt(pjVal,10)||0; var bRand=((document.querySelector('input[name="gRandom"]:checked')||{value:'Tidak'}).value==='Ya'); var bAktif=((document.querySelector('input[name="gStatus"]:checked')||{value:'Ya'}).value==='Ya'); var isPrioritas=false; fetch('@Url.Content("~/Questions/Group/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NoPaket:np, NoGroup:null, NamaGroup:nm, MinimumJmlSoal:ms, NilaiStandar:ns, WaktuPengerjaan:w, NoPetunjuk:pj, bRandom:bRand, IsPrioritas:isPrioritas, bAktif:bAktif, User:'@User.Identity?.Name' }) }).then(function(){ selected.paket=''+np; fetchGroup(selected.paket); }); }); }).catch(function(){ openModal('Tambah Group Soal', groupForm(o), function(){ var np=parseInt(selected.paket||'0',10); var nm=(document.getElementById('gNamaGroup').value||'').trim(); var ms=parseInt(document.getElementById('gMinSoal').value||'0',10)||0; var ns=parseInt(document.getElementById('gNilaiStandar').value||'0',10)||0; var w=parseInt(document.getElementById('gWaktu').value||'0',10)||0; var pjVal=(document.getElementById('gNoPetunjuk').value||''); var pj=parseInt(pjVal,10)||0; var bRand=((document.querySelector('input[name="gRandom"]:checked')||{value:'Tidak'}).value==='Ya'); var bAktif=((document.querySelector('input[name="gStatus"]:checked')||{value:'Ya'}).value==='Ya'); var isPrioritas=false; fetch('@Url.Content("~/Questions/Group/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NoPaket:np, NoGroup:null, NamaGroup:nm, MinimumJmlSoal:ms, NilaiStandar:ns, WaktuPengerjaan:w, NoPetunjuk:pj, bRandom:bRand, IsPrioritas:isPrioritas, bAktif:bAktif, User:'@User.Identity?.Name' }) }).then(function(){ selected.paket=''+np; fetchGroup(selected.paket); }); }); }); });
      document.getElementById('btnDeleteGroup').addEventListener('click', function(){ var keys=getSelectedKeys('#tblGroup'); if(keys.length===0){ toast('Pilih data'); return; } var doDelete=function(){ var nums=keys.map(function(k){ var n=parseInt(k,10); return isNaN(n)?null:n; }).filter(function(x){ return x!==null; }); Promise.all(nums.map(function(n){ return fetch('@Url.Content("~/Questions/Group/Delete")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NoGroup:n }) }); })).then(function(){ fetchGroup(selected.paket); }); }; if(window.DCT3Modals && typeof DCT3Modals.open==='function'){ DCT3Modals.open('confirmation',{ message:'Yakin ingin menghapus data ini?', onYes:doDelete }); } else { if(confirm('Yakin ingin menghapus data ini?')){ doDelete(); } } });
      wireSelect('#tblGroup','selectAllGroup', function(scope,key,sel){
        selected.group=key;
        fetchDtl(selected.paket, selected.group).then(function(){
          if(rawDtl && rawDtl.length>0){
            selected.dtlSeqNo=rawDtl[0].seqNo||rawDtl[0].noSoal;
            setSingleSelection('#tblDtl', rawDtl[0].noSoal);
            var nu=rawDtl[0].noUrut;
            return fetchJawaban(selected.paket, selected.group, nu);
          } else {
            selected.dtlSeqNo=null;
            rawJawaban=[]; applyJawaban();
          }
        });
      });

      document.getElementById('btnAddDtl').addEventListener('click', function(){ if(!selected.paket || !selected.group){ openModal('Informasi', '<div>Pilih Paket dan Group terlebih dahulu.</div>', null); return; } var o={ noPaket:selected.paket, noGroup:selected.group }; openModal('Tambah Pertanyaan', dtlForm(o), async function(){ var np=parseInt(selected.paket||'0',10); var ng=parseInt(selected.group||'0',10); var nu=(function(){ var m=0; (rawDtl||[]).forEach(function(r){ if(r && r.noUrut){ m=Math.max(m, r.noUrut); } }); return (m||0)+1; })(); var jd=(document.getElementById('dJudul').value||'').trim(); var ds=(document.getElementById('dDeskripsi').value||'').trim(); if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances.dDeskripsi){ ds = CKEDITOR.instances.dDeskripsi.getData(); } else { var rt=document.getElementById('dDeskripsiRT'); if(rt) ds=rt.innerHTML; } var id=(document.querySelector('input[name="dIsDownload"]:checked')||{value:'Tidak'}).value; var ak=(document.querySelector('input[name="dAktif"]:checked')||{value:'Ya'}).value; var tmr=(document.querySelector('input[name="dTipeMedia"]:checked')||{value:'NOMEDIA'}).value; var tm=(tmr==='NOMEDIA'?'NOMEDIA':(tmr==='LINK'?'LINK':'UPLOAD')); var um=document.getElementById('dUrlMedia').value||''; var mediaFile='NOMEDIA'; var bDownload=id==='Ya'; var bAktif=ak==='Ya'; if(tm==='NOMEDIA'){ um=''; } else if(tm==='LINK'){ if(um==='No Media') um=''; } else if(tm==='UPLOAD'){ var f=document.getElementById('dUploadFile'); if(f && f.files && f.files.length>0){ if(!validateImageFile(f.files[0])){ return; } var fd=new FormData(); fd.append('file', f.files[0]); var up=await fetch('@Url.Content("~/Questions/Detail/UploadMedia")',{ method:'POST', body:fd }); var uj=await up.json(); if(up.ok){ um=uj.url||''; mediaFile=uj.fileName||'NOMEDIA'; } else { toast((uj && uj.error)||'Gagal upload media'); return; } } else { toast('Pilih file untuk upload'); return; } } return fetch('@Url.Content("~/Questions/Detail/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:null, NoPaket:np, NoGroup:ng, NoUrut:nu, Judul:jd, Deskripsi:ds, IsDownload:bDownload, bAktif:bAktif, MediaFileName:mediaFile, UrlMedia:um, TipeMedia:tm, User:'@User.Identity?.Name' }) }).then(function(){ selected.paket=''+np; selected.group=''+ng; fetchDtl(selected.paket, selected.group); }); }); });
      document.getElementById('btnImportDtl').addEventListener('click', function(){
        openModal('Import Pertanyaan', importFormBody('impDtl','detail'), function(){
          var f = (document.getElementById('impDtl')||{}).files ? document.getElementById('impDtl').files[0] : null;
          if(!f){ toast('File tidak dipilih'); return; }
          if(!/\.xlsx$/i.test(f.name||'')){ toast('Format file harus XLSX'); return; }
          var fd = new FormData();
          fd.append('file', f);
          var d = getImportDefaults('detail');
          if(d.noPaket) fd.append('noPaket', d.noPaket);
          if(d.noGroup) fd.append('noGroup', d.noGroup);
          return fetch('@Url.Content("~/Questions/Import/Detail")',{ method:'POST', body:fd })
            .then(function(r){ return r.json().then(function(data){ return { ok:r.ok, data:data }; }); })
            .then(function(res){
              if(!res.ok){ toast((res.data && res.data.error) || 'Gagal import'); return; }
              var c = res.data && typeof res.data.count === 'number' ? res.data.count : 0;
              if(c===0){ toast('Data kosong'); return; }
              toast('Berhasil import ' + c + ' pertanyaan');
              fetchDtl(selected.paket, selected.group);
            });
        }, {
          saveText:'Import',
          saveIcon:'@Url.Content("~/DCT3_Standarisasi/assets/icons/importNB.png")',
          templateText:'Template',
          templateIcon:'@Url.Content("~/DCT3_Standarisasi/assets/icons/templateNB.png")',
          onTemplate:function(){ window.location=buildTemplateUrl('detail'); }
        });
      });
      document.getElementById('btnDeleteDtl').addEventListener('click', function(){ var keys=getSelectedKeys('#tblDtl'); if(keys.length===0){ toast('Pilih data'); return; } var doDelete=function(){ var nums=keys.map(function(k){ var n=parseInt(k,10); return isNaN(n)?null:n; }).filter(function(x){ return x!==null; }); Promise.all(nums.map(function(n){ return fetch('@Url.Content("~/Questions/Detail/Delete")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:n }) }); })).then(function(){ fetchDtl(selected.paket, selected.group); }); }; if(window.DCT3Modals && typeof DCT3Modals.open==='function'){ DCT3Modals.open('confirmation',{ message:'Yakin ingin menghapus data ini?', onYes:doDelete }); } else { if(confirm('Yakin ingin menghapus data ini?')){ doDelete(); } } });
      document.getElementById('btnCopyDtl').addEventListener('click', function(){ var keys=getSelectedKeys('#tblDtl'); if(keys.length===0){ toast('Pilih data'); return; } var opts = rawGroup.map(function(g){ return '<option value="'+g.noGroup+'">'+g.noGroup+' - '+g.namaGroup+'</option>'; }).join(''); var body = '<div class="grid gap-2"><label class="text-sm">No Group Tujuan</label><select id="cpyNoGroup" class="border border-gray-300 rounded-md px-2 py-1">'+opts+'</select></div>'; openModal('Copy Pertanyaan', body, function(){ var dest = parseInt(document.getElementById('cpyNoGroup').value||'0',10); Promise.all(keys.map(function(k){ var idx=findByKey(rawDtl,'seqNo',k); if(idx===-1) idx=findByKey(rawDtl,'noSoal',k); var seq = (idx>-1 && rawDtl[idx].seqNo) ? parseInt(rawDtl[idx].seqNo,10) : parseInt(k,10); return fetch('@Url.Content("~/Questions/Detail/Copy")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:seq, DestNoGroup:dest, User:'@User.Identity?.Name' }) }); })).then(function(){ fetchDtl(selected.paket, selected.group); }); }); });
      wireSelect('#tblDtl','selectAllDtl', function(scope,key,sel){ selected.dtlSeqNo=key; var idx=findByKey(rawDtl,'seqNo',key); if(idx===-1) idx=findByKey(rawDtl,'noSoal',key); var nu = (idx>-1) ? rawDtl[idx].noUrut : 0; fetchJawaban(selected.paket, selected.group, nu); });

      document.getElementById('btnAddJawaban').addEventListener('click', function(){ if(!selected.paket || !selected.group || !selected.dtlSeqNo){ openModal('Informasi', '<div>Pilih Pertanyaan terlebih dahulu.</div>', null); return; } var o={ noPaket:selected.paket, noGroup:selected.group }; openModal('Tambah Jawaban', jawabanForm(o), async function(){ var np=parseInt(selected.paket||'0',10); var ng=parseInt(selected.group||'0',10); var idx=findByKey(rawDtl,'seqNo',selected.dtlSeqNo); if(idx<0) idx=findByKey(rawDtl,'noSoal',selected.dtlSeqNo); var nu=(idx>-1)?rawDtl[idx].noUrut:0; var nj=parseInt(document.getElementById('jNoJawaban').value||'0',10)||((function(){ var m=0; (rawJawaban||[]).forEach(function(r){ if(r && r.noJawaban){ m=Math.max(m, r.noJawaban); } }); return (m||0)+1; })()); var jw=(document.getElementById('jJawaban').value||'').trim(); var pn=parseInt(document.getElementById('jPoin').value||'0',10); var tmr=(document.querySelector('input[name="jTipeMedia"]:checked')||{value:'NOMEDIA'}).value; var tm=(tmr==='NOMEDIA'?'NOMEDIA':(tmr==='LINK'?'LINK':'UPLOAD')); var um=document.getElementById('jUrlMedia').value||''; var txt=(document.getElementById('jTextMedia').value||''); var mediaFile='NOMEDIA'; if(tm==='NOMEDIA'){ um=''; } else if(tm==='LINK'){ if(um==='No Media') um=''; } else if(tm==='UPLOAD'){ var f=document.getElementById('jUploadFile'); if(f && f.files && f.files.length>0){ if(!validateImageFile(f.files[0])){ return; } var fd=new FormData(); fd.append('file', f.files[0]); var up=await fetch('@Url.Content("~/Questions/Detail/UploadMedia")',{ method:'POST', body:fd }); var uj=await up.json(); if(up.ok){ um=uj.url||''; mediaFile=uj.fileName||'NOMEDIA'; } else { toast((uj && uj.error)||'Gagal upload media'); return; } } else { toast('Pilih file untuk upload'); return; } } return fetch('@Url.Content("~/Questions/Answer/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:null, NoPaket:np, NoGroup:ng, NoUrut:nu, NoJawaban:nj, Jawaban:jw, PoinJawaban:pn, MediaFileName:mediaFile, UrlMedia:um, TipeMedia:tm, TextMedia:txt, User:'@User.Identity?.Name' }) }).then(function(){ fetchJawaban(np,ng,nu); }); }); });
      document.getElementById('btnImportJawaban').addEventListener('click', function(){
        openModal('Import Jawaban', importFormBody('impJawaban','answer'), function(){
          var f = (document.getElementById('impJawaban')||{}).files ? document.getElementById('impJawaban').files[0] : null;
          if(!f){ toast('File tidak dipilih'); return; }
          if(!/\.xlsx$/i.test(f.name||'')){ toast('Format file harus XLSX'); return; }
          var fd = new FormData();
          fd.append('file', f);
          var d = getImportDefaults('answer');
          if(d.noPaket) fd.append('noPaket', d.noPaket);
          if(d.noGroup) fd.append('noGroup', d.noGroup);
          if(d.noSoal) fd.append('noSoal', d.noSoal);
          return fetch('@Url.Content("~/Questions/Import/Answer")',{ method:'POST', body:fd })
            .then(function(r){ return r.json().then(function(data){ return { ok:r.ok, data:data }; }); })
            .then(function(res){
              if(!res.ok){ toast((res.data && res.data.error) || 'Gagal import'); return; }
              var c = res.data && typeof res.data.count === 'number' ? res.data.count : 0;
              if(c===0){ toast('Data kosong'); return; }
              toast('Berhasil import ' + c + ' jawaban');
              var idx = findByKey(rawDtl,'seqNo',selected.dtlSeqNo);
              if(idx===-1) idx = findByKey(rawDtl,'noSoal',selected.dtlSeqNo);
              var nu = (idx>-1 && rawDtl[idx]) ? rawDtl[idx].noUrut : 0;
              fetchJawaban(selected.paket, selected.group, nu);
            });
        }, {
          saveText:'Import',
          saveIcon:'@Url.Content("~/DCT3_Standarisasi/assets/icons/importNB.png")',
          templateText:'Template',
          templateIcon:'@Url.Content("~/DCT3_Standarisasi/assets/icons/templateNB.png")',
          onTemplate:function(){ window.location=buildTemplateUrl('answer'); }
        });
      });
      document.getElementById('btnDeleteJawaban').addEventListener('click', function(){ var keys=getSelectedKeys('#tblJawaban'); if(keys.length===0){ toast('Pilih data'); return; } var doDelete=function(){ var nums=keys.map(function(k){ var n=parseInt(k,10); return isNaN(n)?null:n; }).filter(function(x){ return x!==null; }); Promise.all(nums.map(function(n){ return fetch('@Url.Content("~/Questions/Answer/Delete")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:n }) }); })).then(function(){ var idx=findByKey(rawDtl,'seqNo',selected.dtlSeqNo); if(idx===-1) idx=findByKey(rawDtl,'noSoal',selected.dtlSeqNo); var nu=(idx>-1)? rawDtl[idx].noUrut : 0; fetchJawaban(selected.paket, selected.group, nu); }); }; if(window.DCT3Modals && typeof DCT3Modals.open==='function'){ DCT3Modals.open('confirmation',{ message:'Yakin ingin menghapus data ini?', onYes:doDelete }); } else { if(confirm('Yakin ingin menghapus data ini?')){ doDelete(); } } });

      document.querySelector('#tblPaket tbody').addEventListener('click', function(e){ var b=e.target.closest('.row-edit-btn'); if(!b) return; var key=b.getAttribute('data-key'); var idx=findByKey(rawPaket,'noPaket',key); if(idx<0) return; var obj=rawPaket[idx]; openModal('Edit Paket Soal', paketForm(obj), function(){ var np=parseInt((document.getElementById('fNoPaket').value||obj.noPaket),10)||0; var na=(document.getElementById('fNamaPaket').value||obj.namaPaket).trim(); var to=parseInt(document.getElementById('fToleransi').value||obj.toleransi,10); var st=(document.querySelector('input[name="fStatus"]:checked')||{value:obj.status}).value; var pos=normalizePosList((document.getElementById('fPosition').value||'').trim()).join(','); fetch('@Url.Content("~/Questions/Paket/Edit")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NoPaket:np, NamaPaket:na, ToleransiWaktu:to, Status:st, Position:pos, User:'@User.Identity?.Name' }) }).then(function(r){ return r.text().then(function(t){ var data=null; if(t){ try{ data=JSON.parse(t); } catch(e){} } if(!r.ok){ toast((data&&data.error)||'Gagal edit paket'); return; } fetchPaket(); }); }); }); });
      document.querySelector('#tblGroup tbody').addEventListener('click', function(e){ var b=e.target.closest('.row-edit-btn'); if(!b) return; var key=b.getAttribute('data-key'); var idx=findByKey(rawGroup,'noGroup',key); if(idx<0) return; var obj=rawGroup[idx]; ensurePetunjuk().then(function(){ openModal('Edit Group Soal', groupForm(obj), function(){ var np=parseInt(selected.paket||'0',10); var ng=parseInt((document.getElementById('gNoGroup').value||obj.noGroup||'0'),10); var nm=(document.getElementById('gNamaGroup').value||obj.namaGroup||'').trim(); var ms=parseInt(document.getElementById('gMinSoal').value||obj.minSoal||'0',10)||0; var ns=parseInt(document.getElementById('gNilaiStandar').value||obj.nilaiStandar||'0',10)||0; var w=parseInt(document.getElementById('gWaktu').value||obj.waktu||'0',10)||0; var pjVal=(document.getElementById('gNoPetunjuk').value||''); var pj=parseInt(pjVal,10)||0; var bRand=((document.querySelector('input[name="gRandom"]:checked')||{value:(obj.random==='Ya'?'Ya':'Tidak')}).value==='Ya'); var bAktif=((document.querySelector('input[name="gStatus"]:checked')||{value:(obj.status==='AKTIF'?'Ya':'Tidak')}).value==='Ya'); var isPrioritas=!!obj.isPrioritas; fetch('@Url.Content("~/Questions/Group/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NoPaket:np, NoGroup:ng, NamaGroup:nm, MinimumJmlSoal:ms, NilaiStandar:ns, WaktuPengerjaan:w, NoPetunjuk:pj, bRandom:bRand, IsPrioritas:isPrioritas, bAktif:bAktif, User:'@User.Identity?.Name' }) }).then(function(){ fetchGroup(selected.paket); }); }); }).catch(function(){ openModal('Edit Group Soal', groupForm(obj), function(){ var np=parseInt(selected.paket||'0',10); var ng=parseInt((document.getElementById('gNoGroup').value||obj.noGroup||'0'),10); var nm=(document.getElementById('gNamaGroup').value||obj.namaGroup||'').trim(); var ms=parseInt(document.getElementById('gMinSoal').value||obj.minSoal||'0',10)||0; var ns=parseInt(document.getElementById('gNilaiStandar').value||obj.nilaiStandar||'0',10)||0; var w=parseInt(document.getElementById('gWaktu').value||obj.waktu||'0',10)||0; var pjVal=(document.getElementById('gNoPetunjuk').value||''); var pj=parseInt(pjVal,10)||0; var bRand=((document.querySelector('input[name="gRandom"]:checked')||{value:(obj.random==='Ya'?'Ya':'Tidak')}).value==='Ya'); var bAktif=((document.querySelector('input[name="gStatus"]:checked')||{value:(obj.status==='AKTIF'?'Ya':'Tidak')}).value==='Ya'); var isPrioritas=!!obj.isPrioritas; fetch('@Url.Content("~/Questions/Group/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ NoPaket:np, NoGroup:ng, NamaGroup:nm, MinimumJmlSoal:ms, NilaiStandar:ns, WaktuPengerjaan:w, NoPetunjuk:pj, bRandom:bRand, IsPrioritas:isPrioritas, bAktif:bAktif, User:'@User.Identity?.Name' }) }).then(function(){ fetchGroup(selected.paket); }); }); }); });
      document.querySelector('#tblDtl tbody').addEventListener('click', function(e){ var b=e.target.closest('.row-edit-btn'); if(!b) return; var key=b.getAttribute('data-key'); var idx=findByKey(rawDtl,'seqNo',key); if(idx===-1) idx=findByKey(rawDtl,'noSoal',key); if(idx<0) return; var obj=rawDtl[idx]; openModal('Edit Pertanyaan', dtlForm(obj), async function(){ var sp=parseInt(document.getElementById('dSeqNo').value||obj.seqNo||obj.noSoal,10)||0; var np=parseInt(document.getElementById('dNoPaket').value||'0',10); var ng=parseInt(document.getElementById('dNoGroup').value||'0',10); var nu=parseInt(document.getElementById('dNoUrut').value||obj.noUrut,10); var jd=(document.getElementById('dJudul').value||obj.judul||'').trim(); var ds=(document.getElementById('dDeskripsi').value||obj.deskripsi||'').trim(); if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances.dDeskripsi){ ds = CKEDITOR.instances.dDeskripsi.getData(); } else { var rt=document.getElementById('dDeskripsiRT'); if(rt) ds=rt.innerHTML; } var id=(document.querySelector('input[name="dIsDownload"]:checked')||{value:(obj.isDownload||'Tidak')}).value; var ak=(document.querySelector('input[name="dAktif"]:checked')||{value:(obj.aktif||'Ya')}).value; var tmr=(document.querySelector('input[name="dTipeMedia"]:checked')||{value:(obj.tipeMedia||'NOMEDIA')}).value; var tm=(tmr==='NOMEDIA'?'NOMEDIA':(tmr==='LINK'?'LINK':'UPLOAD')); var um=document.getElementById('dUrlMedia').value||obj.urlMedia||''; var mediaFile='NOMEDIA'; var bDownload=id==='Ya'; var bAktif=ak==='Ya'; if(tm==='NOMEDIA'){ um=''; } else if(tm==='LINK'){ if(um==='No Media') um=''; } else if(tm==='UPLOAD'){ var f=document.getElementById('dUploadFile'); if(f && f.files && f.files.length>0){ if(!validateImageFile(f.files[0])){ return; } var fd=new FormData(); fd.append('file', f.files[0]); var up=await fetch('@Url.Content("~/Questions/Detail/UploadMedia")',{ method:'POST', body:fd }); var uj=await up.json(); if(up.ok){ um=uj.url||''; mediaFile=uj.fileName||'NOMEDIA'; } else { toast((uj && uj.error)||'Gagal upload media'); return; } } else { toast('Pilih file untuk upload'); return; } } return fetch('@Url.Content("~/Questions/Detail/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:sp, NoPaket:np, NoGroup:ng, NoUrut:nu, Judul:jd, Deskripsi:ds, IsDownload:bDownload, bAktif:bAktif, MediaFileName:mediaFile, UrlMedia:um, TipeMedia:tm, User:'@User.Identity?.Name' }) }).then(function(){ selected.paket=''+np; selected.group=''+ng; fetchDtl(selected.paket, selected.group); }); }); });
      (function(){ if (!window.CKEDITOR){ var s=document.createElement('script'); s.src='https://cdn.ckeditor.com/4.25.1/standard/ckeditor.js'; document.head.appendChild(s); } })();
      document.querySelector('#tblJawaban tbody').addEventListener('click', function(e){ var b=e.target.closest('.row-edit-btn'); if(!b) return; var key=b.getAttribute('data-key'); var idx=findByKey(rawJawaban,'seqNo',key); if(idx<0) return; var p=getSelectedPaketObj(); if(p && isAktifStatus(p.status)){ e.preventDefault(); e.stopImmediatePropagation(); ModalAlert('Data yang status Paket Soalnya Aktif tidak dapat di edit'); return; } var obj=rawJawaban[idx]; openModal('Edit Jawaban', jawabanForm(obj), async function(){ var sq=parseInt(document.getElementById('jSeqNo').value||obj.seqNo||'0',10)||0; var np=parseInt(document.getElementById('jNoPaket').value||'0',10); var ng=parseInt(document.getElementById('jNoGroup').value||'0',10); var nu=parseInt(document.getElementById('jNoUrut').value||'0',10); var nj=parseInt(document.getElementById('jNoJawaban').value||obj.noJawaban,10); var jw=(document.getElementById('jJawaban').value||obj.jawaban||'').trim(); var pn=parseInt(document.getElementById('jPoin').value||obj.poin||'0',10); var tmr=(document.querySelector('input[name="jTipeMedia"]:checked')||{value:(obj.tipeMedia||'NOMEDIA')}).value; var tm=(tmr==='NOMEDIA'?'NOMEDIA':(tmr==='LINK'?'LINK':'UPLOAD')); var um=document.getElementById('jUrlMedia').value||obj.urlMedia||''; var txt=(document.getElementById('jTextMedia').value||obj.textMedia||''); var mediaFile='NOMEDIA'; if(tm==='NOMEDIA'){ um=''; } else if(tm==='LINK'){ if(um==='No Media') um=''; } else if(tm==='UPLOAD'){ var f=document.getElementById('jUploadFile'); if(f && f.files && f.files.length>0){ if(!validateImageFile(f.files[0])){ return; } var fd=new FormData(); fd.append('file', f.files[0]); var up=await fetch('@Url.Content("~/Questions/Detail/UploadMedia")',{ method:'POST', body:fd }); var uj=await up.json(); if(up.ok){ um=uj.url||''; mediaFile=uj.fileName||'NOMEDIA'; } else { toast((uj && uj.error)||'Gagal upload media'); return; } } } return fetch('@Url.Content("~/Questions/Answer/Modify")',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ SeqNo:sq, NoPaket:np, NoGroup:ng, NoUrut:nu, NoJawaban:nj, Jawaban:jw, PoinJawaban:pn, MediaFileName:mediaFile, UrlMedia:um, TipeMedia:tm, TextMedia:txt, User:'@User.Identity?.Name' }) }).then(function(){ fetchJawaban(np,ng,nu); }); }); });
      wireSelect('#tblJawaban','selectAllJawaban');

      ensurePetunjuk();
      fetchPaket(); applyGroup(); applyDtl(); applyJawaban();
    })();
 </script>
 </div>
