@{
    ViewData["Title"] = "Nilai Screening";
    Layout = "_DashboardLayout";
}
<div class="px-0 py-0 text-[#111827]">
  <h1 class="text-3xl font-semibold text-[#1E90FF]">Nilai Screening</h1>
  <div class="mt-4 flex gap-2">
    <button id="tabBtnInterview" class="px-4 py-2 rounded-md bg-[#1E90FF] text-white">Interview</button>
    <button id="tabBtnPsikotest" class="px-4 py-2 rounded-md bg-gray-200 text-gray-800">Psikotest</button>
  </div>

  <div id="tabInterview" class="mt-4 bg-white border border-gray-200 rounded-xl p-4">
    <div class="text-lg font-semibold mb-2">Data Pribadi</div>
    <div id="personalList" class="mb-4"></div>

    <div class="text-lg font-semibold mt-6 mb-2">Pengalaman Kerja</div>
    <div id="experienceList" class="mb-4"></div>

    <div class="text-lg font-semibold mt-6 mb-2">Kepribadian</div>
    <div id="personalityList" class="mb-4"></div>

    <div class="mt-4">
      <label class="block text-sm text-gray-700">Apa Kelebihan dan kekurangan anda sebagai pribadi / manusia ?</label>
      <textarea id="strengthWeakness" class="border border-gray-300 rounded-md px-2 py-1 w-full" rows="3"></textarea>
    </div>
    <div class="mt-3">
      <label class="block text-sm text-gray-700">Apa hal yang anda sukai dan yang tidak anda sukai ?</label>
      <textarea id="likeDislike" class="border border-gray-300 rounded-md px-2 py-1 w-full" rows="3"></textarea>
    </div>

    <div class="mt-4">
      <label class="block text-sm text-gray-700">Hasil Interview</label>
      <select id="hasilInterview" class="border border-gray-300 rounded-md px-2 py-1 w-full">
        <option value="">Pilih</option>
        <option value="Lulus">Lulus</option>
        <option value="Tidak Lulus">Tidak Lulus</option>
      </select>
    </div>
    <div class="mt-3">
      <label class="block text-sm text-gray-700">Remarks</label>
      <textarea id="remarksInterview" class="border border-gray-300 rounded-md px-2 py-1 w-full" rows="3"></textarea>
    </div>
    <div class="mt-3">
      <label class="block text-sm text-gray-700">Dokumentasi Interview</label>
      <input id="fileInterview" type="file" class="border border-gray-300 rounded-md px-2 py-1 w-full" />
      <a id="downloadInterview" class="text-sm text-blue-600 underline mt-2 inline-block" target="_blank" href="#" style="display:none;">Download File</a>
    </div>
    <div class="mt-6">
      <button id="saveInterview" class="px-4 py-2 rounded-md bg-[#1E90FF] text-white">Simpan Interview</button>
    </div>
  </div>

  <div id="tabPsikotest" class="mt-4 bg-white border border-gray-200 rounded-xl p-4 hidden">
    <div class="text-lg font-semibold mb-2">Hasil Ujian</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-700">Hasil Psikotest</label>
        <select id="hasilPsikotest" class="border border-gray-300 rounded-md px-2 py-1 w-full">
          <option value="">Pilih</option>
          <option value="Lulus">Lulus</option>
          <option value="Tidak Lulus">Tidak Lulus</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-700">Dokumentasi Psikotest</label>
        <input id="filePsikotest" type="file" class="border border-gray-300 rounded-md px-2 py-1 w-full" />
        <a id="downloadPsikotest" class="text-sm text-blue-600 underline mt-2 inline-block" target="_blank" href="#" style="display:none;">Download File</a>
      </div>
    </div>
    <div class="mt-4">
      <button id="savePsikotest" class="px-4 py-2 rounded-md bg-[#1E90FF] text-white">Simpan Psikotest</button>
    </div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-4 items-start">
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm">
        <div class="flex flex-col gap-2">
          <div class="flex gap-2"><span class="w-28 text-gray-500">Nomor Peserta</span><span id="bioNomor"></span></div>
          <div class="flex gap-2"><span class="w-28 text-gray-500">Nama</span><span id="bioName"></span></div>
          <div class="flex gap-2"><span class="w-28 text-gray-500">Email</span><span id="bioEmail"></span></div>
          <div class="flex gap-2"><span class="w-28 text-gray-500">Posisi</span><span id="bioJob"></span></div>
          <div class="flex gap-2"><span class="w-28 text-gray-500">Telepon</span><span id="bioPhone"></span></div>
          <div class="flex gap-2"><span class="w-28 text-gray-500">Pendidikan</span><span id="bioEdu"></span></div>
          <div class="flex gap-2"><span class="w-28 text-gray-500">No KTP</span><span id="bioKtp"></span></div>
        </div>
      </div>
      <div class="border border-gray-200 rounded-md p-4">
        <div class="flex items-center justify-center">
          <svg id="psikoRadar" width="360" height="320" viewBox="0 0 360 320"></svg>
        </div>
        <div class="mt-2 flex justify-center gap-4 text-sm">
          <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 bg-[#1E90FF]"></span><span>Nilai</span></div>
          <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 bg-[#F59E0B]"></span><span>Norma</span></div>
          <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 bg-[#10B981]"></span><span>Nilai Maks</span></div>
        </div>
      </div>
    </div>

    <div id="psikoCards" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3"></div>

    <div class="mt-4 text-lg font-semibold">Hasil Ujian</div>
    <div class="overflow-x-auto mt-2">
      <table class="min-w-full text-sm border">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">Num</th>
            <th class="border px-2 py-1">Nama Group Soal</th>
            <th class="border px-2 py-1">Nilai</th>
            <th class="border px-2 py-1">Nilai Maks</th>
            <th class="border px-2 py-1">Norma</th>
            <th class="border px-2 py-1">Nama Norma</th>
          </tr>
        </thead>
        <tbody id="psikotestSummaryTable"></tbody>
      </table>
    </div>

    <div class="mt-4 text-lg font-semibold">Hasil Jawaban</div>
    <div class="overflow-x-auto mt-2">
      <table class="min-w-full text-sm border">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">Num</th>
            <th class="border px-2 py-1">Judul Soal</th>
            <th class="border px-2 py-1">Deskripsi Soal</th>
            <th class="border px-2 py-1">Jawaban Dipilih</th>
            <th class="border px-2 py-1">Poin</th>
            <th class="border px-2 py-1">Jawaban Benar</th>
            <th class="border px-2 py-1">Poin Benar</th>
          </tr>
        </thead>
        <tbody id="psikotestAnswerTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const biodata = @Html.Raw(ViewData["BiodataJson"]);
  const personal = @Html.Raw(ViewData["PersonalJson"]);
  const experience = @Html.Raw(ViewData["ExperienceJson"]);
  const personality = @Html.Raw(ViewData["PersonalityJson"]);
  const personalRes = @Html.Raw(ViewData["PersonalResultJson"]);
  const experienceRes = @Html.Raw(ViewData["ExperienceResultJson"]);
  const personalityRes = @Html.Raw(ViewData["PersonalityResultJson"]);
  const statusData = @Html.Raw(ViewData["StatusJson"]);
  const psikotest = @Html.Raw(ViewData["PsikotestJson"]) || [];
  const psikotestDetail = @Html.Raw(ViewData["PsikotestDetailJson"]) || [];
  let selectedGroup = "";

  document.getElementById("bioNomor").textContent = biodata.noPeserta || "";
  document.getElementById("bioName").textContent = biodata.name || "";
  document.getElementById("bioEmail").textContent = biodata.email || "";
  document.getElementById("bioJob").textContent = biodata.job || "";
  document.getElementById("bioPhone").textContent = biodata.phone || "";
  document.getElementById("bioEdu").textContent = biodata.pendidikan || "";
  document.getElementById("bioKtp").textContent = biodata.noKtp || "";

  function mapBy(list, key) {
    const m = new Map();
    list.forEach(x => m.set(x[key], x));
    return m;
  }
  const personalMap = mapBy(personalRes, "msSeqNo");
  const experienceMap = mapBy(experienceRes, "msSeqNo");
  const personalityMap = mapBy(personalityRes, "msSeqNo");

  function renderInterviewList(list, map, containerId, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const table = document.createElement("table");
    table.className = "min-w-full text-sm border";
    table.innerHTML = `
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">Num</th>
          <th class="border px-2 py-1">Pertanyaan</th>
          <th class="border px-2 py-1">Jawaban</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");
    list.forEach((item, index) => {
      const res = map.get(item.msSeqNo) || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2 py-1 text-center">${index + 1}</td>
        <td class="border px-2 py-1">${item.question || ""}</td>
        <td class="border px-2 py-1">
          <input type="text" class="border border-gray-300 rounded-md px-2 py-1 w-full" data-ms="${item.msSeqNo}" data-kind="${prefix}" data-field="answer" value="${res.answer || ""}" />
          <input type="hidden" data-ms="${item.msSeqNo}" data-kind="${prefix}" data-field="remark" value="${res.remark || ""}" />
        </td>
      `;
      tbody.appendChild(tr);
    });
    container.appendChild(table);
  }

  function normalizePersonalityValue(v) {
    const s = (v == null ? "" : String(v)).trim();
    if (!s) return "";
    if (s === "1") return "Kurang";
    if (s === "2") return "Cukup";
    if (s === "3") return "Baik";
    return s;
  }

  function renderPersonality(list, map, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const table = document.createElement("table");
    table.className = "min-w-full text-sm border";
    table.innerHTML = `
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">Num</th>
          <th class="border px-2 py-1">Aspect</th>
          <th class="border px-2 py-1">Uraian</th>
          <th class="border px-2 py-1">Penilaian</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");
    list.forEach((item, index) => {
      const res = map.get(item.msSeqNo) || {};
      const selected = normalizePersonalityValue(res.nilai);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2 py-1 text-center">${index + 1}</td>
        <td class="border px-2 py-1">${item.aspek || ""}</td>
        <td class="border px-2 py-1">${item.uraian || ""}</td>
        <td class="border px-2 py-1">
          <select class="border border-gray-300 rounded-md px-2 py-1 w-full" data-ms="${item.msSeqNo}" data-kind="personality">
            <option value="">Pilih</option>
            <option value="Baik" ${selected === "Baik" ? "selected" : ""}>Baik</option>
            <option value="Cukup" ${selected === "Cukup" ? "selected" : ""}>Cukup</option>
            <option value="Kurang" ${selected === "Kurang" ? "selected" : ""}>Kurang</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
    });
    container.appendChild(table);
  }

  renderInterviewList(personal, personalMap, "personalList", "personal");
  renderInterviewList(experience, experienceMap, "experienceList", "experience");
  renderPersonality(personality, personalityMap, "personalityList");

  document.getElementById("hasilInterview").value = statusData.hasilInterview || "";
  document.getElementById("remarksInterview").value = statusData.remarks || "";
  document.getElementById("strengthWeakness").value = statusData.strengthWeakness || "";
  document.getElementById("likeDislike").value = statusData.likeDislike || "";
  if (statusData.interviewFile) {
    const link = document.getElementById("downloadInterview");
    link.href = `/Screening/Biodata/Interview/Download?kodeBiodata=${biodata.seqNo}`;
    link.style.display = "inline-block";
  }

  function normaLabel(result, standard) {
    return result >= standard ? "Cukup" : "Rendah";
  }

  function normaClass(result, standard) {
    return result >= standard ? "bg-amber-400" : "bg-red-500";
  }

  const summaryBody = document.getElementById("psikotestSummaryTable");

  function renderPsikotestSummary() {
    summaryBody.innerHTML = "";
    psikotest.forEach((row, index) => {
      const label = normaLabel(row.nilaiGroupResult, row.nilaiStandard);
      const tr = document.createElement("tr");
      tr.setAttribute("data-group", row.noGroup || "");
      tr.className = "cursor-pointer hover:bg-blue-50";
      if (selectedGroup !== "" && String(row.noGroup || "") === String(selectedGroup)) {
        tr.classList.add("bg-blue-100");
      }
      tr.innerHTML = `
        <td class="border px-2 py-1 text-center">${index + 1}</td>
        <td class="border px-2 py-1">${row.namaGroup || row.noGroup || ""}</td>
        <td class="border px-2 py-1 text-center">${row.nilaiGroupResult}</td>
        <td class="border px-2 py-1 text-center">${row.nilaiMax || 0}</td>
        <td class="border px-2 py-1 text-center">${row.nilaiStandard}</td>
        <td class="border px-2 py-1 text-center">${label}</td>
      `;
      summaryBody.appendChild(tr);
    });
  }

  function renderPsikotestCards() {
    const cards = document.getElementById("psikoCards");
    cards.innerHTML = "";
    psikotest.forEach(row => {
      const label = normaLabel(row.nilaiGroupResult, row.nilaiStandard);
      const card = document.createElement("div");
      card.className = `rounded-md ${normaClass(row.nilaiGroupResult, row.nilaiStandard)} text-white p-3 text-center`;
      card.innerHTML = `
        <div class="text-sm font-semibold">${row.namaGroup || row.noGroup || ""}</div>
        <div class="text-xs mt-1">${label}</div>
        <div class="text-lg font-semibold">${row.nilaiGroupResult}/${row.nilaiMax || 0}</div>
      `;
      cards.appendChild(card);
    });
  }

  function renderPsikotestAnswers() {
    const body = document.getElementById("psikotestAnswerTable");
    body.innerHTML = "";
    const rows = selectedGroup === ""
      ? psikotestDetail
      : psikotestDetail.filter(x => String(x.noGroup || "") === String(selectedGroup));
    rows.forEach((row, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2 py-1 text-center">${index + 1}</td>
        <td class="border px-2 py-1">${row.judul || ""}</td>
        <td class="border px-2 py-1">${row.deskripsi || ""}</td>
        <td class="border px-2 py-1 text-center">${row.jawabanDipilih || ""}</td>
        <td class="border px-2 py-1 text-center">${row.poin || 0}</td>
        <td class="border px-2 py-1 text-center">${row.jawabanBenar || ""}</td>
        <td class="border px-2 py-1 text-center">${row.poinBenar || 0}</td>
      `;
      body.appendChild(tr);
    });
  }

  summaryBody.addEventListener("click", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;
    const group = tr.getAttribute("data-group") || "";
    selectedGroup = group === selectedGroup ? "" : group;
    renderPsikotestSummary();
    renderPsikotestAnswers();
  });

  function drawRadar() {
    const svg = document.getElementById("psikoRadar");
    if (!svg) return;
    const labels = psikotest.map(x => x.namaGroup || x.noGroup || "");
    const values = psikotest.map(x => x.nilaiGroupResult || 0);
    const standards = psikotest.map(x => x.nilaiStandard || 0);
    const maxValues = psikotest.map(x => x.nilaiMax || 0);
    const count = labels.length;
    svg.innerHTML = "";
    if (count === 0) return;
    const width = 360;
    const height = 320;
    const cx = width / 2;
    const cy = height / 2;
    const radius = Math.min(width, height) / 2 - 40;
    const maxVal = Math.max(1, ...values, ...standards, ...maxValues);
    const ns = "http://www.w3.org/2000/svg";

    function pointAt(i, value) {
      const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
      const r = (value / maxVal) * radius;
      return { x: cx + Math.cos(angle) * r, y: cy + Math.sin(angle) * r };
    }

    function polygonPoints(arr) {
      return arr.map((v, i) => {
        const p = pointAt(i, v);
        return `${p.x},${p.y}`;
      }).join(" ");
    }

    function makeText(x, y, text, size, color, weight) {
      const t = document.createElementNS(ns, "text");
      t.setAttribute("x", x);
      t.setAttribute("y", y);
      t.setAttribute("font-size", String(size));
      t.setAttribute("fill", color);
      t.setAttribute("text-anchor", "middle");
      if (weight) t.setAttribute("font-weight", weight);
      t.textContent = text;
      return t;
    }

    if (count === 1) {
      const v = values[0];
      const s = standards[0];
      const m = maxValues[0];
      const ring = radius - 12;
      const base = document.createElementNS(ns, "circle");
      base.setAttribute("cx", cx);
      base.setAttribute("cy", cy);
      base.setAttribute("r", ring);
      base.setAttribute("fill", "none");
      base.setAttribute("stroke", "#E5E7EB");
      base.setAttribute("stroke-width", "16");
      svg.appendChild(base);

      function arcPath(value, r) {
        const ang = (value / maxVal) * Math.PI * 2;
        const start = -Math.PI / 2;
        const end = start + ang;
        const large = ang > Math.PI ? 1 : 0;
        const x1 = cx + Math.cos(start) * r;
        const y1 = cy + Math.sin(start) * r;
        const x2 = cx + Math.cos(end) * r;
        const y2 = cy + Math.sin(end) * r;
        return `M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`;
      }

      const maxArc = document.createElementNS(ns, "path");
      maxArc.setAttribute("d", arcPath(m, ring));
      maxArc.setAttribute("fill", "none");
      maxArc.setAttribute("stroke", "#10B981");
      maxArc.setAttribute("stroke-width", "16");
      maxArc.setAttribute("stroke-linecap", "round");
      maxArc.setAttribute("opacity", "0.35");
      svg.appendChild(maxArc);

      const normArc = document.createElementNS(ns, "path");
      normArc.setAttribute("d", arcPath(s, ring));
      normArc.setAttribute("fill", "none");
      normArc.setAttribute("stroke", "#F59E0B");
      normArc.setAttribute("stroke-width", "10");
      normArc.setAttribute("stroke-linecap", "round");
      svg.appendChild(normArc);

      const valArc = document.createElementNS(ns, "path");
      valArc.setAttribute("d", arcPath(v, ring));
      valArc.setAttribute("fill", "none");
      valArc.setAttribute("stroke", "#1E90FF");
      valArc.setAttribute("stroke-width", "10");
      valArc.setAttribute("stroke-linecap", "round");
      svg.appendChild(valArc);

      svg.appendChild(makeText(cx, cy - 6, `${v}/${m || 0}`, 22, "#111827", "600"));
      svg.appendChild(makeText(cx, cy + 16, `Norma ${s}`, 12, "#6B7280"));
      svg.appendChild(makeText(cx, cy + 34, labels[0] || "Group Soal", 12, "#374151", "500"));
      return;
    }

    for (let level = 1; level <= 5; level++) {
      const r = (radius * level) / 5;
      const points = labels.map((_, i) => {
        const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
        return `${cx + Math.cos(angle) * r},${cy + Math.sin(angle) * r}`;
      }).join(" ");
      const grid = document.createElementNS(ns, "polygon");
      grid.setAttribute("points", points);
      grid.setAttribute("fill", "none");
      grid.setAttribute("stroke", "#E5E7EB");
      svg.appendChild(grid);
    }

    labels.forEach((label, i) => {
      const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
      const x = cx + Math.cos(angle) * (radius + 12);
      const y = cy + Math.sin(angle) * (radius + 12);
      const line = document.createElementNS(ns, "line");
      line.setAttribute("x1", cx);
      line.setAttribute("y1", cy);
      line.setAttribute("x2", cx + Math.cos(angle) * radius);
      line.setAttribute("y2", cy + Math.sin(angle) * radius);
      line.setAttribute("stroke", "#E5E7EB");
      svg.appendChild(line);
      svg.appendChild(makeText(x, y, label, 10, "#374151"));
    });

    const normPoly = document.createElementNS(ns, "polygon");
    normPoly.setAttribute("points", polygonPoints(standards));
    normPoly.setAttribute("fill", "rgba(245, 158, 11, 0.25)");
    normPoly.setAttribute("stroke", "#F59E0B");
    svg.appendChild(normPoly);

    const valPoly = document.createElementNS(ns, "polygon");
    valPoly.setAttribute("points", polygonPoints(values));
    valPoly.setAttribute("fill", "rgba(30, 144, 255, 0.25)");
    valPoly.setAttribute("stroke", "#1E90FF");
    svg.appendChild(valPoly);

    const maxPoly = document.createElementNS(ns, "polygon");
    maxPoly.setAttribute("points", polygonPoints(maxValues));
    maxPoly.setAttribute("fill", "rgba(16, 185, 129, 0.18)");
    maxPoly.setAttribute("stroke", "#10B981");
    svg.appendChild(maxPoly);

    values.forEach((v, i) => {
      const p = pointAt(i, v);
      const dot = document.createElementNS(ns, "circle");
      dot.setAttribute("cx", p.x);
      dot.setAttribute("cy", p.y);
      dot.setAttribute("r", "3.5");
      dot.setAttribute("fill", "#1E90FF");
      svg.appendChild(dot);
      svg.appendChild(makeText(p.x, p.y - 8, String(v), 9, "#111827", "600"));
    });
  }

  renderPsikotestSummary();
  renderPsikotestCards();
  renderPsikotestAnswers();
  drawRadar();
  document.getElementById("hasilPsikotest").value = statusData.hasilPsikotest || "";
  if (statusData.psikotestFile) {
    const link = document.getElementById("downloadPsikotest");
    link.href = `/Screening/Biodata/Psikotest/Download?kodeBiodata=${biodata.seqNo}`;
    link.style.display = "inline-block";
  }

  document.getElementById("tabBtnInterview").addEventListener("click", () => {
    document.getElementById("tabInterview").classList.remove("hidden");
    document.getElementById("tabPsikotest").classList.add("hidden");
    document.getElementById("tabBtnInterview").classList.add("bg-[#1E90FF]", "text-white");
    document.getElementById("tabBtnInterview").classList.remove("bg-gray-200", "text-gray-800");
    document.getElementById("tabBtnPsikotest").classList.add("bg-gray-200", "text-gray-800");
    document.getElementById("tabBtnPsikotest").classList.remove("bg-[#1E90FF]", "text-white");
  });
  document.getElementById("tabBtnPsikotest").addEventListener("click", () => {
    document.getElementById("tabPsikotest").classList.remove("hidden");
    document.getElementById("tabInterview").classList.add("hidden");
    document.getElementById("tabBtnPsikotest").classList.add("bg-[#1E90FF]", "text-white");
    document.getElementById("tabBtnPsikotest").classList.remove("bg-gray-200", "text-gray-800");
    document.getElementById("tabBtnInterview").classList.add("bg-gray-200", "text-gray-800");
    document.getElementById("tabBtnInterview").classList.remove("bg-[#1E90FF]", "text-white");
  });

  function collectInterview(prefix) {
    const answers = [];
    document.querySelectorAll(`[data-kind="${prefix}"][data-field="answer"]`).forEach(el => {
      const ms = parseInt(el.getAttribute("data-ms"), 10);
      const remarkEl = document.querySelector(`[data-kind="${prefix}"][data-field="remark"][data-ms="${ms}"]`);
      answers.push({
        msSeqNo: ms,
        question: "",
        answer: el.value || "",
        remark: remarkEl ? remarkEl.value || "" : ""
      });
    });
    return answers;
  }

  function collectPersonality() {
    const out = [];
    document.querySelectorAll(`[data-kind="personality"]`).forEach(el => {
      const ms = parseInt(el.getAttribute("data-ms"), 10);
      const val = (el.value || "").trim();
      const item = personality.find(p => p.msSeqNo === ms) || {};
      out.push({
        msSeqNo: ms,
        aspek: item.aspek || "",
        uraian: item.uraian || "",
        nilai: val
      });
    });
    return out;
  }

  function ModalAlert(msg){
    if(window.DCT3Modals){ DCT3Modals.open('alert', { message: msg || '' }); }
    else { alert(msg || ''); }
  }
  function ModalInformation(msg){
    if(window.DCT3Modals){ DCT3Modals.open('information', { message: msg || '' }); }
    else { alert(msg || ''); }
  }
  function ModalFailed(msg){
    if(window.DCT3Modals){ DCT3Modals.open('failed', { message: msg || '' }); }
    else { alert(msg || ''); }
  }

  document.getElementById("saveInterview").addEventListener("click", async () => {
    const hasil = document.getElementById("hasilInterview").value;
    const file = document.getElementById("fileInterview").files[0];
    if (!hasil) {
      ModalAlert("Hasil interview wajib diisi");
      return;
    }
    if (!file && !statusData.interviewFile) {
      ModalAlert("File hasil interview wajib diupload");
      return;
    }
    const payload = {
      personal: collectInterview("personal"),
      experience: collectInterview("experience"),
      personality: collectPersonality()
    };
    const fd = new FormData();
    fd.append("seqNo", biodata.seqNo);
    fd.append("hasilInterview", hasil);
    fd.append("remarks", document.getElementById("remarksInterview").value || "");
    fd.append("strengthWeakness", document.getElementById("strengthWeakness").value || "");
    fd.append("likeDislike", document.getElementById("likeDislike").value || "");
    fd.append("answers", JSON.stringify(payload));
    if (file) fd.append("file", file);
    const res = await fetch("/Screening/Biodata/Interview/Save", { method: "POST", body: fd });
    const json = await res.json();
    if (!res.ok) {
      ModalFailed(json.error || "Gagal menyimpan");
      return;
    }
    ModalInformation("Berhasil menyimpan interview");
    location.reload();
  });

  document.getElementById("savePsikotest").addEventListener("click", async () => {
    const hasil = document.getElementById("hasilPsikotest").value;
    const file = document.getElementById("filePsikotest").files[0];
    if (!hasil) {
      ModalAlert("Hasil psikotest wajib diisi");
      return;
    }
    if (!file && !statusData.psikotestFile) {
      ModalAlert("File hasil psikotest wajib diupload");
      return;
    }
    const fd = new FormData();
    fd.append("seqNo", biodata.seqNo);
    fd.append("hasilPsikotest", hasil);
    if (file) fd.append("file", file);
    const res = await fetch("/Screening/Biodata/Psikotest/Save", { method: "POST", body: fd });
    const json = await res.json();
    if (!res.ok) {
      ModalFailed(json.error || "Gagal menyimpan");
      return;
    }
    ModalInformation("Berhasil menyimpan psikotest");
    location.reload();
  });
</script>
